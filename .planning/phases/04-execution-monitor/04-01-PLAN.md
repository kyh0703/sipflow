---
phase: 04-execution-monitor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/engine/events.go
  - internal/engine/executor.go
  - frontend/src/features/scenario-builder/types/execution.ts
  - frontend/src/features/scenario-builder/store/execution-store.ts
autonomous: true

must_haves:
  truths:
    - "Go 백엔드가 SIP 메시지 상세 정보(direction, method, responseCode)를 action-log 이벤트에 포함하여 프론트엔드로 전달한다"
    - "프론트엔드 ExecutionStore가 SIP 메시지 상세 정보를 저장하고 sipMessages 배열로 제공한다"
    - "엣지 애니메이션을 위한 edgeAnimations 상태가 store에 존재하고 이벤트에 의해 업데이트된다"
  artifacts:
    - path: "internal/engine/events.go"
      provides: "SIP 메시지 상세 정보 포함 이벤트 발행"
      contains: "sipMessage"
    - path: "frontend/src/features/scenario-builder/types/execution.ts"
      provides: "SIPMessageDetail 타입, EdgeAnimationMessage 타입"
      exports: ["SIPMessageDetail", "EdgeAnimationMessage"]
    - path: "frontend/src/features/scenario-builder/store/execution-store.ts"
      provides: "sipMessages 상태, edgeAnimations 상태, useShallow 최적화"
      contains: "sipMessages"
  key_links:
    - from: "internal/engine/executor.go"
      to: "internal/engine/events.go"
      via: "emitActionLog 호출 시 sipMessage 맵 포함"
      pattern: "sipMessage.*direction"
    - from: "frontend/src/features/scenario-builder/store/execution-store.ts"
      to: "frontend/src/features/scenario-builder/types/execution.ts"
      via: "SIPMessageDetail, EdgeAnimationMessage 타입 import"
      pattern: "import.*SIPMessageDetail"
---

<objective>
Go 백엔드의 SIP 메시지 상세 정보 발행과 프론트엔드 타입/스토어 확장으로 Phase 04 전체의 데이터 기반을 구축한다.

Purpose: 엣지 애니메이션, 로그 상세 정보, 타임라인 패널 모두 SIP 메시지 상세 정보에 의존하므로, 이 기반이 없으면 어떤 시각화도 구현 불가
Output: SIP 메시지 상세 정보가 포함된 이벤트 시스템 + 확장된 프론트엔드 상태 관리
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-execution-monitor/04-RESEARCH.md
@.planning/phases/03-sip-engine/03-05-SUMMARY.md

Key existing files:
@internal/engine/events.go
@internal/engine/executor.go
@frontend/src/features/scenario-builder/types/execution.ts
@frontend/src/features/scenario-builder/store/execution-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Go 백엔드 SIP 메시지 상세 정보 이벤트 확장</name>
  <files>internal/engine/events.go, internal/engine/executor.go</files>
  <action>
  1. `internal/engine/events.go`에서 `emitActionLog` 메서드를 확장하여 선택적 SIP 메시지 상세 정보를 포함할 수 있도록 수정:
     - 새 메서드 시그니처: `emitActionLog(nodeID, instanceID, message, level string, opts ...ActionLogOption)`
     - `ActionLogOption` 타입 정의 (functional options 패턴):
       ```go
       type ActionLogOption func(data map[string]interface{})

       func WithSIPMessage(direction, method string, responseCode int, callID, from, to string) ActionLogOption {
           return func(data map[string]interface{}) {
               data["sipMessage"] = map[string]interface{}{
                   "direction":    direction,
                   "method":       method,
                   "responseCode": responseCode,
                   "callId":       callID,
                   "from":         from,
                   "to":           to,
               }
           }
       }
       ```
     - 기존 emitActionLog 호출은 변경 불필요 (가변인자이므로 하위 호환)
     - emitActionLog 내부에서 opts 순회하며 data 맵에 적용

  2. `internal/engine/executor.go`의 주요 SIP 액션에서 WithSIPMessage 옵션 추가:
     - `executeMakeCall`: 성공 시 `WithSIPMessage("sent", "INVITE", 200, callID, fromURI, toURI)` 추가
       - callID는 dialog.ID() 또는 가용한 식별자 사용
       - from/to는 node.TargetURI에서 추출
     - `executeAnswer`: 성공 시 `WithSIPMessage("received", "INVITE", 200, callID, from, to)` 추가
       - serverSession에서 FromUser() 활용
     - `executeRelease`: 성공 시 `WithSIPMessage("sent", "BYE", 200, callID, "", "")` 추가
     - `executeIncoming`: 수신 시 `WithSIPMessage("received", "INVITE", 0, "", fromUser, "")` 추가
     - `executeRinging`: `WithSIPMessage("received", "RINGING", 180, "", "", "")` 추가

  **주의사항:**
  - diago의 DialogSession 인터페이스에서 Call-ID 접근이 불가능할 수 있음 → 그 경우 빈 문자열로 설정하고 주석으로 기록
  - responseCode가 해당 없는 경우 0 사용
  - 기존 테스트와의 호환성 유지 (가변인자이므로 기존 호출은 깨지지 않음)
  - 타임스탬프는 기존 `time.Now().UnixMilli()` 패턴 유지 (밀리초)
  </action>
  <verify>
  - `cd /home/overthinker/Project/sipflow && go build ./internal/engine/...` 컴파일 성공
  - `go test ./internal/engine/... -run .` 기존 테스트 통과
  - events.go에서 `ActionLogOption` 타입과 `WithSIPMessage` 함수 존재 확인 (grep)
  - executor.go에서 `WithSIPMessage` 호출이 최소 4곳에 존재 확인 (grep)
  </verify>
  <done>emitActionLog가 선택적 sipMessage 맵을 포함하여 발행하고, 주요 SIP 커맨드/이벤트에서 direction/method/responseCode가 포함된 로그가 생성된다. 기존 테스트가 모두 통과한다.</done>
</task>

<task type="auto">
  <name>Task 2: 프론트엔드 타입 확장 + ExecutionStore SIP 메시지 및 엣지 애니메이션 상태 추가</name>
  <files>frontend/src/features/scenario-builder/types/execution.ts, frontend/src/features/scenario-builder/store/execution-store.ts</files>
  <action>
  1. `types/execution.ts`에 새 타입 추가:
     ```typescript
     export interface SIPMessageDetail {
       direction: 'sent' | 'received';
       method?: string;          // INVITE, BYE, ACK, CANCEL
       responseCode?: number;    // 200, 180, 404, 0 (해당없음)
       callId?: string;
       from?: string;
       to?: string;
     }
     ```
     - `ActionLogEvent` 인터페이스에 `sipMessage?: SIPMessageDetail` 필드 추가
     - `ActionLog` 인터페이스에 `sipMessage?: SIPMessageDetail` 필드 추가

     엣지 애니메이션용 타입:
     ```typescript
     export interface EdgeAnimationMessage {
       id: string;           // 고유 ID
       edgeId: string;       // XYFlow edge ID
       method: string;       // SIP 메서드 (INVITE, BYE 등)
       timestamp: number;    // 시작 타임스탬프
       duration: number;     // 애니메이션 지속 시간 (ms), 기본 1000
     }
     ```

  2. `execution-store.ts` 확장:
     - `ExecutionState` 인터페이스에 추가:
       - `sipMessages: ActionLog[]` — sipMessage 필드가 있는 로그만 필터링한 별도 배열
       - `edgeAnimations: EdgeAnimationMessage[]` — 현재 활성 엣지 애니메이션
       - `addEdgeAnimation: (animation: EdgeAnimationMessage) => void`
       - `removeEdgeAnimation: (id: string) => void`
     - `addActionLog` 메서드 수정:
       - 기존 로직 유지
       - 이벤트에 sipMessage가 있으면 sipMessages 배열에도 추가 (최대 500개)
       - sipMessage가 있으면 해당 nodeId에서 연결된 엣지를 찾아 edgeAnimation 생성
         - 엣지 조회를 위해 ScenarioStore에서 edges를 가져오는 것은 복잡하므로, 대신 `addEdgeAnimation`을 별도 메서드로 노출하고, 엣지 애니메이션 트리거는 컴포넌트 레벨에서 처리
     - `reset()` 메서드에 `sipMessages: [], edgeAnimations: []` 초기화 추가
     - **useShallow 최적화**: store 파일 상단에 주석으로 `// 컴포넌트에서 사용 시: import { useShallow } from 'zustand/react/shallow'` 안내 추가

  **주의사항:**
  - edgeAnimations의 자동 정리: setTimeout으로 duration(기본 1000ms) 후 removeEdgeAnimation 호출하는 방식을 store 외부(컴포넌트)에서 처리
  - 기존 ActionLogEvent에 optional 필드를 추가하는 것이므로 기존 코드와 하위 호환
  - sipMessages는 별도 배열로 유지하여 타임라인 패널이 전체 actionLogs를 순회하지 않도록 최적화
  </action>
  <verify>
  - `cd /home/overthinker/Project/sipflow/frontend && npx tsc --noEmit 2>&1 | head -30` TypeScript 컴파일 에러 없음 (프로젝트 레벨 에러 제외)
  - types/execution.ts에 `SIPMessageDetail`, `EdgeAnimationMessage` 인터페이스 존재 (grep)
  - execution-store.ts에 `sipMessages`, `edgeAnimations` 상태 존재 (grep)
  - execution-store.ts에 `addEdgeAnimation`, `removeEdgeAnimation` 메서드 존재 (grep)
  </verify>
  <done>SIPMessageDetail과 EdgeAnimationMessage 타입이 정의되고, ExecutionStore가 sipMessages와 edgeAnimations 상태를 관리하며, addActionLog가 sipMessage를 포함한 로그를 sipMessages 배열에도 추가한다.</done>
</task>

</tasks>

<verification>
1. Go 빌드: `go build ./internal/engine/...` 성공
2. Go 테스트: `go test ./internal/engine/...` 기존 테스트 통과
3. TypeScript: SIPMessageDetail, EdgeAnimationMessage 타입 정의 확인
4. ExecutionStore: sipMessages, edgeAnimations 상태 및 관련 메서드 존재
5. 하위 호환: 기존 ActionLogEvent에 optional 필드만 추가되어 기존 코드 깨지지 않음
</verification>

<success_criteria>
- Go 백엔드가 SIP 메시지 상세 정보를 포함한 action-log 이벤트를 발행한다
- 프론트엔드 타입 시스템이 SIP 메시지 상세 정보와 엣지 애니메이션 메시지를 지원한다
- ExecutionStore가 sipMessages와 edgeAnimations 상태를 관리한다
- 기존 코드와 테스트가 모두 정상 동작한다
</success_criteria>

<output>
완료 후, `.planning/phases/04-execution-monitor/04-01-SUMMARY.md` 생성
</output>
