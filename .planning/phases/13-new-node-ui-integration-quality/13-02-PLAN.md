---
phase: 13-new-node-ui-integration-quality
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/engine/graph_test.go
autonomous: true

must_haves:
  truths:
    - "Hold, Retrieve 커맨드의 ParseScenario 파싱이 단위 테스트로 검증된다"
    - "v1.1 시나리오(PlayAudio, SendDTMF, DTMFReceived)가 v1.2 ParseScenario로 정상 파싱된다"
    - "기존 Phase 10/11 Go 테스트가 모두 PASS 상태를 유지한다"
  artifacts:
    - path: "internal/engine/graph_test.go"
      provides: "Hold/Retrieve 파싱 테스트 + v1.1 하위 호환성 테스트"
      contains: "TestParseScenario_HoldFields"
  key_links:
    - from: "graph_test.go TestParseScenario_HoldFields"
      to: "graph.go ParseScenario"
      via: "Hold command 노드 JSON 파싱"
      pattern: "ParseScenario"
    - from: "graph_test.go TestParseScenario_V1_1_BackwardCompatibility"
      to: "graph.go getStringField"
      via: "누락 필드 기본값 처리"
      pattern: "getStringField"
---

<objective>
Go 단위 테스트를 추가하여 NF-01(새 Command/Event 핸들러 테스트)과 NF-02(하위 호환성) 요구사항을 완성한다.

Purpose: Hold/Retrieve 파싱 테스트 갭을 채우고, v1.1 시나리오의 v1.2 파서 호환성을 명시적으로 검증
Output: graph_test.go에 3개 테스트 함수 추가, 전체 엔진 테스트 PASS
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-new-node-ui-integration-quality/13-RESEARCH.md
@internal/engine/graph_test.go
@internal/engine/graph.go
@internal/engine/executor_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Hold/Retrieve 파싱 + v1.1 하위 호환성 Go 테스트 추가</name>
  <files>internal/engine/graph_test.go</files>
  <action>
    graph_test.go 파일 끝에 3개 테스트 함수를 추가한다.

    **1. TestParseScenario_HoldFields:**
    - 기존 TestParseScenario_PlayAudioFields 패턴을 따름
    - Hold command 노드가 포함된 flowJSON 정의 (inst-a + cmd-1 Hold, sipInstanceId="inst-a")
    - ParseScenario 호출 후 검증:
      - cmd1.Command == "Hold"
      - cmd1.TargetUser == "" (Hold는 target 파라미터 없음)
      - cmd1.TargetHost == "" (Hold는 target 파라미터 없음)

    **2. TestParseScenario_RetrieveFields:**
    - Hold와 동일 패턴
    - Retrieve command 노드 포함 flowJSON 정의
    - ParseScenario 호출 후 검증:
      - cmd1.Command == "Retrieve"
      - cmd1.TargetUser == "" (Retrieve는 target 파라미터 없음)

    **3. TestParseScenario_V1_1_BackwardCompatibility:**
    - NF-02 요구사항: v1.1 시나리오 포맷이 v1.2에서 깨지지 않음을 검증
    - v1.1 시나리오를 시뮬레이션하는 flowJSON 정의:
      - 2개 SIP Instance (inst-a, inst-b)
      - MakeCall (inst-a, targetUri 포함)
      - INCOMING (inst-b)
      - Answer (inst-b)
      - PlayAudio (inst-a, filePath 포함)
      - SendDTMF (inst-a, digits + intervalMs 포함)
      - DTMFReceived (inst-b, expectedDigit 포함)
      - Release (inst-a)
      - DISCONNECTED (inst-b)
    - 노드에 targetUser, targetHost, codecs 등 v1.2 신규 필드가 누락된 상태
    - ParseScenario 호출 후 검증:
      - 에러 없이 파싱 성공
      - 인스턴스 2개 존재
      - MakeCall의 TargetURI가 올바르게 파싱됨
      - PlayAudio의 FilePath가 올바르게 파싱됨
      - SendDTMF의 Digits, IntervalMs가 올바르게 파싱됨
      - DTMFReceived의 ExpectedDigit가 올바르게 파싱됨
      - v1.2 신규 필드(TargetUser, TargetHost)는 빈 문자열 기본값

    모든 테스트는 기존 패턴과 일관된 스타일로 작성:
    - flowJSON은 raw string literal로 인라인 정의
    - `t.Fatalf`/`t.Errorf` 패턴으로 실패 메시지 작성
    - 한글 주석으로 검증 의도 설명
  </action>
  <verify>
    1. `cd /home/overthinker/Project/sipflow && go test ./internal/engine/... -run "TestParseScenario_HoldFields|TestParseScenario_RetrieveFields|TestParseScenario_V1_1_BackwardCompatibility" -v` — 3개 테스트 PASS
    2. `cd /home/overthinker/Project/sipflow && go test ./internal/engine/... -run "TestParseScenario|TestExecute" -v -count=1 -timeout 30s` — 기존 테스트 포함 전체 PASS (TestIntegration_TwoPartyCallSimulation 제외 — 이 테스트는 기존 FAIL이며 Phase 13 범위 외)
  </verify>
  <done>
    - TestParseScenario_HoldFields PASS — Hold 커맨드 파싱 검증
    - TestParseScenario_RetrieveFields PASS — Retrieve 커맨드 파싱 검증
    - TestParseScenario_V1_1_BackwardCompatibility PASS — v1.1 시나리오 하위 호환성 검증
    - 기존 Phase 10/11 테스트 (TestExecuteHold_NoDialog, TestExecuteBlindTransfer_*, TestExecuteEvent_*Switch 등) 전체 PASS 유지
    - NF-01 충족: 새 Command/Event 핸들러에 대한 Go 단위 테스트 완비
    - NF-02 충족: v1.1 시나리오가 v1.2에서 정상 로드됨이 테스트로 보장
  </done>
</task>

</tasks>

<verification>
1. `go test ./internal/engine/... -run "TestParseScenario|TestExecute" -v -count=1 -timeout 30s` — 전체 단위 테스트 PASS
2. 새 3개 테스트 함수가 graph_test.go에 존재
3. v1.1 하위 호환성 테스트가 MakeCall, PlayAudio, SendDTMF, DTMFReceived 모두 커버
</verification>

<success_criteria>
- NF-01 충족: Hold, Retrieve, BlindTransfer, HELD, RETRIEVED, TRANSFERRED 전체에 Go 단위 테스트 존재 (기존 Phase 10/11 테스트 + 이 계획의 파싱 테스트)
- NF-02 충족: v1.1 시나리오 포맷의 하위 호환성이 테스트로 검증됨
- 기존 테스트 회귀 없음
</success_criteria>

<output>
완료 후, `.planning/phases/13-new-node-ui-integration-quality/13-02-SUMMARY.md` 생성
</output>
