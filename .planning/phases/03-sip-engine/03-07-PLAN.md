---
plan: "03-07"
title: "프론트엔드 실행 UI — 툴바 + 노드 상태 표시 + 로그 패널"
wave: 4
depends_on: ["03-05"]
files_modified:
  - frontend/src/features/scenario-builder/components/execution-toolbar.tsx
  - frontend/src/features/scenario-builder/components/execution-log.tsx
  - frontend/src/features/scenario-builder/components/nodes/command-node.tsx
  - frontend/src/features/scenario-builder/components/nodes/event-node.tsx
  - frontend/src/features/scenario-builder/components/nodes/sip-instance-node.tsx
  - frontend/src/features/scenario-builder/components/scenario-builder.tsx
autonomous: true
estimated_tasks: 3
---

# Plan 03-07: 프론트엔드 실행 UI — 툴바 + 노드 상태 표시 + 로그 패널

## 목표
Plan 03-05에서 구축한 ExecutionStore와 use-engine-api 훅을 기반으로, 시나리오 실행을 제어하는 툴바, 노드별 실행 상태 시각적 표시, 실행 로그 패널을 구현하고 scenario-builder 레이아웃에 통합한다.

## 컨텍스트
CONTEXT.md 결정사항:
- 툴바에 모드 토글 UI (로컬만 활성화)
- 추상화된 이벤트만 표시 ("MakeCall 시작", "Incoming 수신", "Answer 완료")
- 모드 전환 UX: 툴바에 토글 스위치 (시뮬레이션/실제)

Plan 03-05에서 구현한 항목:
- `execution-store.ts` - Zustand ExecutionStore (이벤트 수신, 상태 관리)
- `execution.ts` - TypeScript 타입 정의
- `use-engine-api.ts` - StartScenario/StopScenario/IsRunning 훅

이 계획은 위 기초 인프라를 사용하여 실제 UI 컴포넌트를 구현한다.

## 태스크

<task id="1">
<title>실행 툴바 컴포넌트</title>
<instruction>
`frontend/src/features/scenario-builder/components/execution-toolbar.tsx` 파일을 새로 생성한다.

시나리오 빌더의 헤더 바에 통합될 실행 컨트롤 컴포넌트이다.

```typescript
import { useEffect } from 'react';
import { Play, Square, ToggleLeft } from 'lucide-react';
import { useExecutionStore } from '../store/execution-store';
import { useScenarioStore } from '../store/scenario-store';
import { useEngineApi } from '../hooks/use-engine-api';
```

구현:
1. ExecutionStore에서 `status`, `startListening`, `stopListening`, `reset` 구독
2. ScenarioStore에서 `currentScenarioId` 구독
3. useEngineApi에서 `startScenario`, `stopScenario` 사용

4. `useEffect`에서 이벤트 리스닝 시작/정리:
   ```typescript
   useEffect(() => {
     startListening();
     return () => stopListening();
   }, [startListening, stopListening]);
   ```

5. `handleStart`:
   - `currentScenarioId`가 없으면 return
   - `reset()` 호출 (이전 실행 상태 초기화)
   - `startScenario(currentScenarioId)` 호출
   - 에러 시 toast/alert 표시

6. `handleStop`:
   - `stopScenario()` 호출
   - 에러 시 toast/alert 표시

7. 렌더링:
   ```tsx
   <div className="flex items-center gap-2">
     {/* 모드 표시 (로컬 모드 전용) */}
     <div className="flex items-center gap-1 px-2 py-1 rounded bg-muted text-xs text-muted-foreground">
       <ToggleLeft size={12} />
       <span>Local</span>
     </div>

     {/* Start 버튼 */}
     <button
       onClick={handleStart}
       disabled={status === 'running' || !currentScenarioId}
       className="flex items-center gap-1 px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
       title="Run scenario"
     >
       <Play size={14} />
       Run
     </button>

     {/* Stop 버튼 */}
     <button
       onClick={handleStop}
       disabled={status !== 'running'}
       className="flex items-center gap-1 px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
       title="Stop scenario"
     >
       <Square size={14} />
       Stop
     </button>

     {/* 상태 표시 */}
     <span className={`text-xs px-2 py-0.5 rounded-full ${statusStyles[status]}`}>
       {status}
     </span>
   </div>
   ```

8. 상태별 스타일 맵:
   ```typescript
   const statusStyles: Record<string, string> = {
     idle: 'bg-muted text-muted-foreground',
     running: 'bg-yellow-100 text-yellow-800 border border-yellow-300',
     completed: 'bg-green-100 text-green-800 border border-green-300',
     failed: 'bg-red-100 text-red-800 border border-red-300',
     stopped: 'bg-orange-100 text-orange-800 border border-orange-300',
   };
   ```
</instruction>
<verify>
`cd frontend && npx tsc --noEmit` 타입 에러 없음 확인.
</verify>
</task>

<task id="2">
<title>노드 컴포넌트에 실행 상태 표시 추가</title>
<instruction>
기존 노드 컴포넌트에 실행 상태에 따른 시각적 피드백을 추가한다.

1. `frontend/src/features/scenario-builder/components/nodes/command-node.tsx` 수정:
   - `useExecutionStore` import 추가
   - `getNodeStatus` 구독: `const nodeExecState = useExecutionStore((state) => state.nodeStates[id]);`
   - 실행 상태에 따른 테두리 스타일 추가:
     - running: `ring-2 ring-yellow-400 shadow-yellow-200` + pulse 애니메이션
     - completed: `ring-2 ring-green-400 shadow-green-200`
     - failed: `ring-2 ring-red-400 shadow-red-200`
   - 기존 `hasError` (validation) 스타일은 유지하되, 실행 상태가 있으면 실행 상태 우선

2. `frontend/src/features/scenario-builder/components/nodes/event-node.tsx` 수정:
   - 동일한 패턴으로 실행 상태 표시 추가
   - running 상태일 때 "Waiting..." 텍스트 추가 표시

3. `frontend/src/features/scenario-builder/components/nodes/sip-instance-node.tsx` 수정:
   - 실행 상태는 직접 표시하지 않지만, 시나리오 실행 중일 때 인스턴스가 "active" 상태인지 표시
   - `useExecutionStore`에서 `status` 구독
   - status === 'running'일 때 미묘한 시각적 표시 (예: 좌측 border에 pulse)

실행 상태 스타일을 결정하는 유틸리티 함수를 노드 컴포넌트 파일 상단에 정의:
```typescript
function getExecutionStyle(status?: string): string {
  switch (status) {
    case 'running':
      return 'ring-2 ring-yellow-400 shadow-yellow-200 animate-pulse';
    case 'completed':
      return 'ring-2 ring-green-400 shadow-green-200';
    case 'failed':
      return 'ring-2 ring-red-400 shadow-red-200';
    default:
      return '';
  }
}
```
</instruction>
<verify>
`cd frontend && npx tsc --noEmit` 타입 에러 없음 확인. 노드 컴포넌트가 기존 기능을 유지하면서 실행 상태를 표시하는지 확인.
</verify>
</task>

<task id="3">
<title>실행 로그 패널 + scenario-builder 레이아웃 통합</title>
<instruction>
1. `frontend/src/features/scenario-builder/components/execution-log.tsx` 파일을 새로 생성한다.

캔버스 하단에 표시되는 실행 로그 패널:

```typescript
import { useEffect, useRef } from 'react';
import { useExecutionStore } from '../store/execution-store';
```

구현:
- ExecutionStore에서 `actionLogs`, `status` 구독
- 로그 목록을 스크롤 가능한 패널로 표시
- 새 로그 추가 시 자동 스크롤 (useRef + scrollIntoView)
- 각 로그 항목: `[timestamp] [level] [instanceId] message`
- level별 색상: info = 기본, warning = 황색, error = 적색
- status가 'idle'이면 패널 숨김 (display: none 또는 조건부 렌더링)
- 최대 높이 200px, overflow-y-auto

```tsx
<div className="border-t border-border bg-background">
  <div className="flex items-center justify-between px-3 py-1 border-b border-border bg-muted/50">
    <span className="text-xs font-medium">Execution Log</span>
    <span className="text-xs text-muted-foreground">{actionLogs.length} entries</span>
  </div>
  <div className="max-h-[200px] overflow-y-auto p-2 font-mono text-xs">
    {actionLogs.map((log) => (
      <div key={log.id} className={`py-0.5 ${logLevelStyles[log.level]}`}>
        <span className="text-muted-foreground">{formatTimestamp(log.timestamp)}</span>
        {' '}
        <span className="text-blue-600">[{log.instanceId || 'system'}]</span>
        {' '}
        {log.message}
      </div>
    ))}
    <div ref={endRef} />
  </div>
</div>
```

timestamp 포맷: `HH:MM:SS.mmm` (밀리초 포함)

2. `frontend/src/features/scenario-builder/components/scenario-builder.tsx` 수정:

현재 레이아웃:
```
[Header Bar (h-10)]
[Left Sidebar (200px) | Canvas (flex-1) | Right Sidebar (280px)]
```

변경 후:
```
[Header Bar (h-10) -- Save + ExecutionToolbar 통합]
[Left Sidebar (200px) | Canvas + ExecutionLog (flex-1) | Right Sidebar (280px)]
```

수정사항:
- `ExecutionToolbar` import 및 헤더 바에 배치 (Save 버튼 왼쪽에)
- `ExecutionLog` import 및 Canvas 아래에 조건부 배치:
  - ExecutionStore의 `status`가 'idle'이 아닐 때만 표시
- 실행 중(`status === 'running'`)일 때 캔버스 위에 반투명 오버레이로 편집 차단 표시 (선택적):
  - `pointer-events-none opacity-75` 클래스 적용 또는
  - 단순히 노드 드래그/연결을 비활성화하지는 않음 (Phase 03에서는 간단히 상태만 표시)

헤더 바 구조 변경:
```tsx
<div className="h-10 border-b border-border bg-background flex items-center justify-between px-4">
  <div className="flex items-center gap-2">
    <span className="text-sm font-medium">
      {currentScenarioName || 'No scenario selected'}
    </span>
    {isDirty && (
      <span className="text-xs text-muted-foreground">* Modified</span>
    )}
  </div>
  <div className="flex items-center gap-3">
    <ExecutionToolbar />
    <button onClick={handleSave} ...>
      <Save size={14} />
      Save
    </button>
  </div>
</div>
```
</instruction>
<verify>
`cd frontend && npx tsc --noEmit` 타입 에러 없음 확인. 레이아웃이 올바르게 구성되었는지 확인.
</verify>
</task>

## 검증 기준
- [ ] `cd frontend && npx tsc --noEmit` 성공
- [ ] 실행 툴바에 Run/Stop 버튼과 상태 표시
- [ ] 노드 컴포넌트가 실행 상태에 따른 시각적 피드백 표시 (ring 색상)
- [ ] 실행 로그 패널이 액션 로그를 실시간 표시
- [ ] scenario-builder 레이아웃에 툴바와 로그 패널 통합
- [ ] 모드 토글 UI에 "Local" 표시

## must_haves
- Run/Stop 실행 컨트롤 UI (ExecutionToolbar)
- 노드별 실행 상태 시각적 표시 (running/completed/failed)
- 실행 로그 패널 (타임스탬프, 레벨, 메시지)
- scenario-builder 레이아웃 통합
- 모드 토글 UI (Local 표시, Phase 03에서는 로컬만 활성화)
