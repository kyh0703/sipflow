---
phase: 08-dtmf-send-receive
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/features/scenario-builder/types/scenario.ts
  - frontend/src/features/scenario-builder/components/node-palette.tsx
  - frontend/src/features/scenario-builder/components/nodes/command-node.tsx
  - frontend/src/features/scenario-builder/components/nodes/event-node.tsx
  - frontend/src/features/scenario-builder/components/properties/command-properties.tsx
  - frontend/src/features/scenario-builder/components/properties/event-properties.tsx
autonomous: true

must_haves:
  truths:
    - "사용자가 노드 팔레트에서 SendDTMF Command 노드를 캔버스에 드래그앤드롭할 수 있다"
    - "사용자가 노드 팔레트에서 DTMFReceived Event 노드를 캔버스에 드래그앤드롭할 수 있다"
    - "사용자가 SendDTMF 노드 Properties 패널에서 DTMF digits(0-9, *, #, A-D)를 입력할 수 있다"
    - "사용자가 SendDTMF 노드 Properties 패널에서 전송 간격(intervalMs)을 설정할 수 있다"
    - "사용자가 DTMFReceived 노드 Properties 패널에서 expectedDigit를 설정할 수 있다"
    - "캔버스에서 SendDTMF 노드에 Hash 아이콘이, DTMFReceived 노드에 Ear 아이콘이 표시된다"
  artifacts:
    - path: "frontend/src/features/scenario-builder/types/scenario.ts"
      provides: "COMMAND_TYPES에 SendDTMF, EVENT_TYPES에 DTMFReceived, CommandNodeData에 digits/intervalMs, EventNodeData에 expectedDigit"
      contains: "SendDTMF"
    - path: "frontend/src/features/scenario-builder/components/node-palette.tsx"
      provides: "SendDTMF와 DTMFReceived PaletteItem"
      contains: "SendDTMF"
    - path: "frontend/src/features/scenario-builder/components/nodes/command-node.tsx"
      provides: "SendDTMF 아이콘 매핑 + digits 표시"
      contains: "SendDTMF.*Hash"
    - path: "frontend/src/features/scenario-builder/components/nodes/event-node.tsx"
      provides: "DTMFReceived 아이콘 매핑 + expectedDigit 표시"
      contains: "DTMFReceived.*Ear"
    - path: "frontend/src/features/scenario-builder/components/properties/command-properties.tsx"
      provides: "SendDTMF digits 입력 + intervalMs 설정 UI"
      contains: "SendDTMF"
    - path: "frontend/src/features/scenario-builder/components/properties/event-properties.tsx"
      provides: "DTMFReceived expectedDigit 입력 + timeout 설정 UI"
      contains: "DTMFReceived"
  key_links:
    - from: "frontend/src/features/scenario-builder/components/node-palette.tsx"
      to: "frontend/src/features/scenario-builder/types/scenario.ts"
      via: "type 문자열 'command-SendDTMF', 'event-DTMFReceived'이 DnD 시 노드 생성에 사용"
      pattern: "command-SendDTMF"
    - from: "frontend/src/features/scenario-builder/components/properties/command-properties.tsx"
      to: "frontend/src/features/scenario-builder/types/scenario.ts"
      via: "CommandNodeData.digits, CommandNodeData.intervalMs 타입 참조"
      pattern: "data\\.digits"
    - from: "frontend/src/features/scenario-builder/components/properties/event-properties.tsx"
      to: "frontend/src/features/scenario-builder/types/scenario.ts"
      via: "EventNodeData.expectedDigit 타입 참조"
      pattern: "data\\.expectedDigit"
---

<objective>
SendDTMF Command와 DTMFReceived Event의 프론트엔드 UI 구현: 타입 정의, 노드 팔레트 항목, 캔버스 렌더링(아이콘+정보표시), Properties 패널 편집 UI.

Purpose: 사용자가 DTMF 노드를 시각적으로 배치하고 설정할 수 있는 프론트엔드 인터페이스를 제공한다.
Output: 6개 프론트엔드 파일에 SendDTMF/DTMFReceived 노드 타입, 팔레트, 캔버스 렌더링, Properties 패널이 추가된다.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-dtmf-send-receive/08-RESEARCH.md
@frontend/src/features/scenario-builder/types/scenario.ts
@frontend/src/features/scenario-builder/components/node-palette.tsx
@frontend/src/features/scenario-builder/components/nodes/command-node.tsx
@frontend/src/features/scenario-builder/components/nodes/event-node.tsx
@frontend/src/features/scenario-builder/components/properties/command-properties.tsx
@frontend/src/features/scenario-builder/components/properties/event-properties.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: 타입 정의 + 노드 팔레트 + 캔버스 렌더링</name>
  <files>
    frontend/src/features/scenario-builder/types/scenario.ts
    frontend/src/features/scenario-builder/components/node-palette.tsx
    frontend/src/features/scenario-builder/components/nodes/command-node.tsx
    frontend/src/features/scenario-builder/components/nodes/event-node.tsx
  </files>
  <action>
**scenario.ts 수정:**
1. COMMAND_TYPES 배열에 'SendDTMF' 추가 (마지막 요소로):
   `['MakeCall', 'Answer', 'Release', 'PlayAudio', 'SendDTMF'] as const`
2. EVENT_TYPES 배열에 'DTMFReceived' 추가 (마지막 요소로):
   기존 'NOTIFY' 뒤에 'DTMFReceived' 추가
3. CommandNodeData 인터페이스에 필드 2개 추가:
   - `digits?: string;` — SendDTMF: DTMF digit 문자열 (예: "1234*#")
   - `intervalMs?: number;` — SendDTMF: digit 간 전송 간격 (밀리초, 기본 100)
4. EventNodeData 인터페이스에 필드 1개 추가:
   - `expectedDigit?: string;` — DTMFReceived: 대기할 특정 digit (빈 문자열이면 아무 digit)

**node-palette.tsx 수정:**
1. lucide-react import에 `Hash`, `Ear` 추가
2. Commands 섹션의 PlayAudio PaletteItem 다음에 SendDTMF 추가:
   ```tsx
   <PaletteItem
     type="command-SendDTMF"
     label="SendDTMF"
     icon={Hash}
     colorClass="bg-blue-50 border-blue-400 text-blue-900"
   />
   ```
3. Events 섹션의 NOTIFY PaletteItem 다음에 DTMFReceived 추가:
   ```tsx
   <PaletteItem
     type="event-DTMFReceived"
     label="DTMFReceived"
     icon={Ear}
     colorClass="bg-amber-50 border-amber-400 text-amber-900"
   />
   ```

연구에서는 Hash(SendDTMF)와 PhoneIncoming(DTMFReceived)을 제안했으나, PhoneIncoming은 이미 Answer 노드 아이콘으로 사용 중. DTMFReceived에는 Ear (lucide-react) 아이콘을 사용하여 "digit을 듣고 대기한다"는 의미를 전달. Ear가 lucide-react에 없으면 Headphones를 대안으로 사용.

**command-node.tsx 수정:**
1. lucide-react import에 `Hash` 추가
2. COMMAND_ICONS 객체에 `SendDTMF: Hash` 추가
3. 캔버스 노드 본문에 SendDTMF 전용 정보 표시 블록 추가 (PlayAudio 패턴 참조):
   ```tsx
   {data.command === 'SendDTMF' && data.digits && (
     <div className="px-3 pb-2">
       <div className="text-xs text-muted-foreground">Digits: {data.digits}</div>
     </div>
   )}
   ```

**event-node.tsx 수정:**
1. lucide-react import에 `Ear` 추가 (없으면 `Headphones`)
2. EVENT_ICONS 객체에 `DTMFReceived: Ear` 추가
3. 캔버스 노드 본문에 DTMFReceived 전용 정보 표시 블록 추가 (TIMEOUT 패턴 참조):
   ```tsx
   {data.event === 'DTMFReceived' && data.expectedDigit && (
     <div className="px-3 pb-2">
       <div className="text-xs text-muted-foreground">Expect: {data.expectedDigit}</div>
     </div>
   )}
   ```
  </action>
  <verify>
`cd /home/overthinker/Project/sipflow/frontend && npx tsc --noEmit` — TypeScript 컴파일 에러 없음.
scenario.ts에서 COMMAND_TYPES에 'SendDTMF', EVENT_TYPES에 'DTMFReceived' 존재 확인.
node-palette.tsx에서 SendDTMF와 DTMFReceived PaletteItem 존재 확인.
command-node.tsx에서 COMMAND_ICONS에 SendDTMF 매핑 존재 확인.
event-node.tsx에서 EVENT_ICONS에 DTMFReceived 매핑 존재 확인.
  </verify>
  <done>
SendDTMF가 COMMAND_TYPES에, DTMFReceived가 EVENT_TYPES에 추가되었다. 노드 팔레트에서 두 노드를 드래그할 수 있다. 캔버스에서 SendDTMF에 Hash 아이콘과 digits 정보가, DTMFReceived에 Ear 아이콘과 expectedDigit 정보가 표시된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: SendDTMF + DTMFReceived Properties 패널 UI</name>
  <files>
    frontend/src/features/scenario-builder/components/properties/command-properties.tsx
    frontend/src/features/scenario-builder/components/properties/event-properties.tsx
  </files>
  <action>
**command-properties.tsx 수정:**
PlayAudio 조건부 블록 다음에 SendDTMF 전용 Properties UI 추가:

```tsx
{data.command === 'SendDTMF' && (
  <>
    <div className="space-y-2">
      <Label htmlFor="digits">Digits</Label>
      <Input
        id="digits"
        value={data.digits || ''}
        onChange={(e) => {
          // 유효한 DTMF 문자만 허용: 0-9, *, #, A-D
          const filtered = e.target.value.replace(/[^0-9*#A-Da-d]/g, '').toUpperCase();
          onUpdate({ digits: filtered });
        }}
        placeholder="1234*#"
        maxLength={20}
      />
      <p className="text-xs text-muted-foreground">
        Valid: 0-9, *, #, A-D (max 20 digits)
      </p>
    </div>

    <div className="space-y-2">
      <Label htmlFor="intervalMs">Interval Between Digits (ms)</Label>
      <Input
        id="intervalMs"
        type="number"
        value={data.intervalMs ?? 100}
        onChange={(e) => {
          const val = parseInt(e.target.value, 10) || 100;
          onUpdate({ intervalMs: Math.max(50, Math.min(1000, val)) });
        }}
        min={50}
        max={1000}
        step={10}
      />
      <p className="text-xs text-muted-foreground">
        Delay between each digit (min: 50ms, default: 100ms)
      </p>
    </div>
  </>
)}
```

- onChange에서 regex 필터로 유효하지 않은 문자 즉시 제거 (입력 시 피드백)
- toUpperCase()로 a-d를 A-D로 자동 변환
- intervalMs는 50-1000ms 범위로 클램프 (RFC 2833 최소 제약)
- nodrag 클래스는 부모 div에 이미 적용되어 있으므로 추가 불필요

**event-properties.tsx 수정:**
기존 TIMEOUT 조건부 블록 다음에 DTMFReceived 전용 Properties UI 추가:

```tsx
{data.event === 'DTMFReceived' && (
  <>
    <Separator />
    <div className="space-y-2">
      <Label htmlFor="expectedDigit">Expected Digit (optional)</Label>
      <Input
        id="expectedDigit"
        value={data.expectedDigit || ''}
        onChange={(e) => {
          // 단일 유효 DTMF 문자만 허용
          const filtered = e.target.value.replace(/[^0-9*#A-Da-d]/g, '').toUpperCase().slice(0, 1);
          onUpdate({ expectedDigit: filtered });
        }}
        placeholder="Leave empty to accept any digit"
        maxLength={1}
      />
      <p className="text-xs text-muted-foreground">
        If set, waits for this specific digit. Empty accepts any.
      </p>
    </div>

    <div className="space-y-2">
      <Label htmlFor="timeout">Timeout (ms)</Label>
      <Input
        id="timeout"
        type="number"
        value={data.timeout ?? 10000}
        onChange={(e) => {
          const val = parseInt(e.target.value, 10) || 10000;
          onUpdate({ timeout: Math.max(1000, Math.min(60000, val)) });
        }}
        min={1000}
        max={60000}
        step={1000}
      />
      <p className="text-xs text-muted-foreground">
        Maximum wait time for DTMF digit (default: 10000ms)
      </p>
    </div>
  </>
)}
```

- expectedDigit는 maxLength={1}로 단일 문자만 허용
- timeout은 1000-60000ms 범위로 클램프 (최소 1초, 최대 1분)
- event-properties.tsx에 Separator import가 이미 존재하는지 확인, 없으면 추가
  </action>
  <verify>
`cd /home/overthinker/Project/sipflow/frontend && npx tsc --noEmit` — TypeScript 컴파일 에러 없음.
command-properties.tsx에서 data.command === 'SendDTMF' 조건부 블록 존재 확인.
event-properties.tsx에서 data.event === 'DTMFReceived' 조건부 블록 존재 확인.
두 Properties 모두 입력 필드에 regex 필터 적용 확인.
  </verify>
  <done>
SendDTMF Properties 패널에서 digits(regex 필터링, 0-9*#A-D) 입력과 intervalMs(50-1000ms) 설정이 가능하다. DTMFReceived Properties 패널에서 expectedDigit(단일 문자) 입력과 timeout(1000-60000ms) 설정이 가능하다. TypeScript 컴파일 성공.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — TypeScript 타입 체크 통과
2. scenario.ts의 COMMAND_TYPES에 'SendDTMF', EVENT_TYPES에 'DTMFReceived' 존재
3. CommandNodeData에 digits, intervalMs 필드 존재
4. EventNodeData에 expectedDigit 필드 존재
5. 노드 팔레트에 SendDTMF(Hash 아이콘)과 DTMFReceived(Ear 아이콘) 항목 존재
6. 캔버스 command-node에서 SendDTMF 아이콘 매핑 + digits 텍스트 표시
7. 캔버스 event-node에서 DTMFReceived 아이콘 매핑 + expectedDigit 텍스트 표시
8. SendDTMF Properties에서 digits 입력 시 유효하지 않은 문자가 필터링됨
9. DTMFReceived Properties에서 expectedDigit가 단일 문자로 제한됨
</verification>

<success_criteria>
- TypeScript 컴파일 성공 (타입 에러 없음)
- 노드 팔레트에서 SendDTMF와 DTMFReceived를 드래그하여 캔버스에 배치 가능
- SendDTMF Properties에서 digits 문자열(regex 필터)과 intervalMs(50-1000ms) 입력 가능
- DTMFReceived Properties에서 expectedDigit(단일 문자)과 timeout(1000-60000ms) 입력 가능
- 캔버스에서 각 노드에 적절한 아이콘과 설정 정보가 표시됨
- 기존 노드 타입(MakeCall, Answer, Release, PlayAudio, INCOMING 등)이 정상 동작 (회귀 없음)
</success_criteria>

<output>
완료 후, `.planning/phases/08-dtmf-send-receive/08-02-SUMMARY.md` 생성
</output>
