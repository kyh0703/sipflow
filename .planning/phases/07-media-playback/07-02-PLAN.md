---
phase: 07-media-playback
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - frontend/src/features/scenario-builder/types/scenario.ts
  - frontend/src/features/scenario-builder/components/node-palette.tsx
  - frontend/src/features/scenario-builder/components/nodes/command-node.tsx
  - frontend/src/features/scenario-builder/components/properties/command-properties.tsx
  - frontend/src/features/scenario-builder/components/canvas.tsx
autonomous: false

must_haves:
  truths:
    - "노드 팔레트에서 PlayAudio Command 노드를 드래그하여 캔버스에 배치할 수 있다"
    - "PlayAudio 노드 Properties 패널에서 파일 선택 버튼을 클릭하면 WAV 파일 다이얼로그가 열린다"
    - "8kHz mono PCM이 아닌 WAV 파일 선택 시 toast 에러가 표시되고 경로가 저장되지 않는다"
    - "유효한 WAV 선택 시 파일명이 노드 배지와 Properties 패널에 표시된다"
    - "PlayAudio 노드가 캔버스에서 기존 Command 노드와 동일한 blue 스타일을 사용한다"
  artifacts:
    - path: "frontend/src/features/scenario-builder/types/scenario.ts"
      provides: "COMMAND_TYPES에 PlayAudio 추가, CommandNodeData에 filePath 필드"
      contains: "PlayAudio"
    - path: "frontend/src/features/scenario-builder/components/node-palette.tsx"
      provides: "PlayAudio 팔레트 항목 (Volume2 아이콘, blue 계열)"
      contains: "PlayAudio"
    - path: "frontend/src/features/scenario-builder/components/nodes/command-node.tsx"
      provides: "PlayAudio 아이콘 매핑 + filePath 배지 표시"
      contains: "Volume2"
    - path: "frontend/src/features/scenario-builder/components/properties/command-properties.tsx"
      provides: "PlayAudio 파일 선택 UI — 파일 선택 버튼, 파일명 표시, 변경 버튼"
      contains: "SelectWAVFile"
  key_links:
    - from: "frontend/src/features/scenario-builder/components/properties/command-properties.tsx"
      to: "wailsjs/go/binding/MediaBinding"
      via: "SelectWAVFile() Wails 바인딩 호출"
      pattern: "SelectWAVFile"
    - from: "frontend/src/features/scenario-builder/components/nodes/command-node.tsx"
      to: "frontend/src/features/scenario-builder/types/scenario.ts"
      via: "COMMAND_ICONS에 PlayAudio: Volume2 매핑"
      pattern: "PlayAudio.*Volume2"
    - from: "frontend/src/features/scenario-builder/components/canvas.tsx"
      to: "node.data.filePath"
      via: "command-PlayAudio 드롭 시 빈 nodeData 생성 (filePath 없음, 이후 Properties에서 설정)"
      pattern: "command-"
---

<objective>
PlayAudio Command 노드의 프론트엔드 전체 구현: 타입 정의, 팔레트 등록, 캔버스 노드 렌더링, Properties 패널 파일 선택 UI.

Purpose: 사용자가 PlayAudio 노드를 캔버스에 배치하고, WAV 파일을 선택/검증하며, 선택된 파일명을 노드와 패널에서 확인할 수 있게 한다.
Output: PlayAudio가 COMMAND_TYPES에 등록되고, 노드 팔레트/캔버스/Properties 패널에서 완전히 동작하는 UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-media-playback/CONTEXT.md
@.planning/phases/07-media-playback/07-RESEARCH.md
@.planning/phases/07-media-playback/07-01-SUMMARY.md

@frontend/src/features/scenario-builder/types/scenario.ts
@frontend/src/features/scenario-builder/components/node-palette.tsx
@frontend/src/features/scenario-builder/components/nodes/command-node.tsx
@frontend/src/features/scenario-builder/components/properties/command-properties.tsx
@frontend/src/features/scenario-builder/components/canvas.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: 타입 정의 + 팔레트 등록 + 캔버스 노드 렌더링</name>
  <files>
    frontend/src/features/scenario-builder/types/scenario.ts
    frontend/src/features/scenario-builder/components/node-palette.tsx
    frontend/src/features/scenario-builder/components/nodes/command-node.tsx
  </files>
  <action>
1. **scenario.ts — COMMAND_TYPES에 PlayAudio 추가:**
   ```typescript
   export const COMMAND_TYPES = ['MakeCall', 'Answer', 'Release', 'PlayAudio'] as const;
   ```

   **CommandNodeData에 filePath 추가:**
   ```typescript
   export interface CommandNodeData extends Record<string, unknown> {
     label: string;
     command: (typeof COMMAND_TYPES)[number];
     sipInstanceId?: string;
     targetUri?: string;
     timeout?: number;
     filePath?: string;  // PlayAudio WAV 파일 절대 경로
   }
   ```

2. **node-palette.tsx — PlayAudio 팔레트 항목 추가:**
   - `Volume2` 아이콘 import 추가 (lucide-react에서)
   - Commands 섹션의 Release 아래에 PlayAudio PaletteItem 추가:
     ```tsx
     <PaletteItem
       type="command-PlayAudio"
       label="PlayAudio"
       icon={Volume2}
       colorClass="bg-blue-50 border-blue-400 text-blue-900"
     />
     ```
   - 기존 Command blue 계열 색상과 동일하게 유지 (사용자 결정: "기존 Command blue 계열")

3. **command-node.tsx — PlayAudio 아이콘 + filePath 배지:**
   - `Volume2` 아이콘 import 추가 (lucide-react에서)
   - `COMMAND_ICONS` 객체에 PlayAudio 추가:
     ```typescript
     const COMMAND_ICONS = {
       MakeCall: Phone,
       Answer: PhoneIncoming,
       Release: PhoneOff,
       PlayAudio: Volume2,
     } as const;
     ```
   - MakeCall의 targetUri 표시 영역 아래에 PlayAudio filePath 배지 추가:
     ```tsx
     {data.command === 'PlayAudio' && data.filePath && (
       <div className="px-3 pb-2">
         <div className="text-xs text-muted-foreground truncate max-w-[140px]" title={data.filePath}>
           {data.filePath.split(/[\\/]/).pop()}
         </div>
       </div>
     )}
     ```
   - 파일명만 표시하고, title 속성으로 전체 절대 경로를 툴팁으로 제공 (사용자 결정: "파일명만 표시, 툴팁으로 전체 경로")
   - `split(/[\\/]/)` 패턴으로 Windows(\) / Unix(/) 경로 모두 지원
  </action>
  <verify>
    `npm run build` 성공 (TypeScript 컴파일 에러 없음). scenario.ts에 PlayAudio가 COMMAND_TYPES에 포함됨.
  </verify>
  <done>
    PlayAudio가 COMMAND_TYPES 타입에 등록되고, 노드 팔레트에 Volume2 아이콘으로 표시되며, 캔버스 노드에서 선택된 파일명이 배지로 표시된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: Properties 패널 파일 선택 UI + Wails 바인딩 연동</name>
  <files>
    frontend/src/features/scenario-builder/components/properties/command-properties.tsx
  </files>
  <action>
1. **command-properties.tsx — PlayAudio 파일 선택 섹션 추가:**

   **import 추가:**
   ```typescript
   import { useState } from 'react';
   import { Button } from '@/components/ui/button';
   import { toast } from 'sonner';
   import { SelectWAVFile } from '../../../../../wailsjs/go/binding/MediaBinding';
   ```
   - 기존 import에 `useState` 추가 (이미 있으면 생략)
   - `Button` import 추가 (기존에 없다면 shadcn/ui에서)
   - `SelectWAVFile` Wails 바인딩 import (Plan 01에서 생성된 MediaBinding)
   - Wails 바인딩 경로는 `wailsjs/go/binding/MediaBinding` — Wails가 자동 생성

   **isSelecting 상태 추가:**
   - 컴포넌트 내부에 `const [isSelecting, setIsSelecting] = useState(false);`
   - 파일 다이얼로그가 열려 있는 동안 버튼 비활성화용

   **handleSelectAudioFile 핸들러:**
   ```typescript
   const handleSelectAudioFile = async () => {
     setIsSelecting(true);
     try {
       const filePath = await SelectWAVFile();
       if (!filePath) return;  // 사용자 취소
       onUpdate({ filePath });
       toast.success('Audio file selected');
     } catch (err: any) {
       // 백엔드에서 검증 실패 에러 반환 (8kHz mono PCM 위반 등)
       toast.error(`Invalid WAV file: ${err?.message || err}`);
     } finally {
       setIsSelecting(false);
     }
   };
   ```

   **PlayAudio 전용 UI (Release 섹션 아래에 추가):**
   ```tsx
   {data.command === 'PlayAudio' && (
     <div className="space-y-2">
       <Label>Audio File</Label>
       {data.filePath ? (
         <div className="flex items-center gap-2">
           <Badge
             variant="outline"
             title={data.filePath}
             className="max-w-[200px] truncate"
           >
             {data.filePath.split(/[\\/]/).pop()}
           </Badge>
           <Button
             size="sm"
             variant="ghost"
             onClick={handleSelectAudioFile}
             disabled={isSelecting}
           >
             Change
           </Button>
         </div>
       ) : (
         <Button
           onClick={handleSelectAudioFile}
           disabled={isSelecting}
           size="sm"
         >
           {isSelecting ? 'Selecting...' : 'Select File'}
         </Button>
       )}
       <p className="text-xs text-muted-foreground">
         Required: 8kHz mono PCM WAV format
       </p>
     </div>
   )}
   ```

   **핵심 동작 흐름 (사용자 결정 엄수):**
   1. "Select File" 버튼 클릭 → SelectWAVFile() 호출
   2. SelectWAVFile()은 OS 파일 다이얼로그 열기 + 선택 후 즉시 검증 (한 번의 호출)
   3. 검증 통과: filePath를 node data에 저장 (onUpdate), toast.success
   4. 검증 실패: 에러 메시지 toast.error, filePath 저장 안 함 (사용자 결정: "검증 실패 시 경로를 노드 데이터에 저장하지 않음")
   5. 사용자 취소: 아무 동작 없음
   6. 파일 선택 후: 파일명만 Badge에 표시, 전체 경로는 title 툴팁 (사용자 결정)
  </action>
  <verify>
    `npm run build` 성공. command-properties.tsx에서 PlayAudio 분기와 SelectWAVFile import가 존재함. `grep -n "SelectWAVFile" frontend/src/features/scenario-builder/components/properties/command-properties.tsx` 결과 확인.
  </verify>
  <done>
    PlayAudio 노드 Properties 패널에서 파일 선택 버튼이 동작하고, 유효한 WAV 선택 시 파일명이 표시되며, 검증 실패 시 toast 에러가 표시된다. 검증 실패 시 filePath가 저장되지 않는다.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    PlayAudio Command 노드 전체 파이프라인:
    - 노드 팔레트에서 PlayAudio(Volume2 아이콘) 드래그하여 캔버스 배치
    - Properties 패널에서 파일 선택 버튼 → Wails 네이티브 파일 다이얼로그 → WAV 파일 선택
    - 8kHz mono PCM이 아닌 파일 선택 시 toast 에러 메시지
    - 유효한 파일 선택 시 캔버스 노드에 파일명 배지 표시
  </what-built>
  <how-to-verify>
    1. `wails dev`로 앱 실행
    2. 왼쪽 팔레트 Commands 섹션에 "PlayAudio" 항목이 Volume2 아이콘과 함께 표시되는지 확인
    3. PlayAudio를 캔버스에 드래그 앤 드롭 — 기존 Command 노드와 같은 blue 스타일인지 확인
    4. PlayAudio 노드 클릭 → Properties 패널에서 "Select File" 버튼 확인
    5. "Select File" 클릭 → OS 파일 다이얼로그가 열리는지 확인
    6. 8kHz mono PCM WAV 파일이 아닌 파일 선택 → toast 에러 메시지 확인 + 노드에 파일명 표시되지 않음 확인
    7. 유효한 8kHz mono PCM WAV 파일 선택 → 파일명이 Properties 패널과 캔버스 노드 배지에 표시되는지 확인
    8. 파일명에 마우스 호버 → 툴팁으로 전체 절대 경로가 표시되는지 확인
    9. 시나리오 저장 후 다시 열기 → filePath가 유지되는지 확인

    유효한 테스트 WAV 파일이 없는 경우:
    - `sox -n -r 8000 -c 1 -b 16 /tmp/test_valid.wav synth 3 sine 440` 으로 생성 가능
    - 또는 `ffmpeg -f lavfi -i "sine=frequency=440:duration=3" -ar 8000 -ac 1 -acodec pcm_s16le /tmp/test_valid.wav`
    - 잘못된 포맷 테스트: `ffmpeg -f lavfi -i "sine=frequency=440:duration=1" -ar 44100 -ac 2 /tmp/test_invalid.wav`
  </how-to-verify>
  <resume-signal>"approved"를 입력하거나 발견된 문제를 설명하세요</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` — 프론트엔드 빌드 성공 (TypeScript 에러 없음)
2. `wails dev` — 앱 정상 실행
3. PlayAudio 노드가 팔레트에 표시되고, 캔버스에 드래그 가능
4. 파일 선택 다이얼로그가 열리고, WAV 검증이 동작
5. 캔버스 노드와 Properties 패널에 파일명 표시
6. 시나리오 저장/로드 시 filePath 유지
</verification>

<success_criteria>
- COMMAND_TYPES에 'PlayAudio'가 포함됨
- 노드 팔레트에 PlayAudio 항목 (Volume2 아이콘, blue 계열) 존재
- 캔버스 노드에 PlayAudio 아이콘과 파일명 배지 표시
- Properties 패널에서 파일 선택 → WAV 검증 → 성공/실패 처리 동작
- 검증 실패 시 filePath 미저장 (사용자 결정 엄수)
- 기존 Command 노드 (MakeCall, Answer, Release) 정상 동작 (회귀 없음)
</success_criteria>

<output>
완료 후, `.planning/phases/07-media-playback/07-02-SUMMARY.md` 생성
</output>
