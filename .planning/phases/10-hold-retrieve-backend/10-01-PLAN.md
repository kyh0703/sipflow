---
phase: 10-hold-retrieve-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/engine/executor.go
  - internal/engine/engine.go
  - internal/engine/events.go
  - internal/engine/graph.go
  - internal/engine/executor_test.go
autonomous: true

must_haves:
  truths:
    - "executeAnswer()가 AnswerOptions()를 호출하여 OnMediaUpdate/OnRefer 콜백을 등록한다"
    - "OnMediaUpdate 콜백이 goroutine으로 분리되어 데드락 없이 LocalSDP()를 파싱한다"
    - "SessionStore가 SIP 이벤트(HELD/RETRIEVED)를 채널로 발행/구독할 수 있다"
    - "Engine이 executor 필드를 통해 emitSIPEvent()로 SessionStore에 이벤트를 전달한다"
    - "WithSIPMessage가 note 파라미터를 지원하면서 기존 호출 코드와 하위 호환된다"
  artifacts:
    - path: "internal/engine/executor.go"
      provides: "AnswerOptions 리팩토링, SessionStore sipEventSubs"
      contains: "AnswerOptions"
    - path: "internal/engine/engine.go"
      provides: "executor 필드, emitSIPEvent 메서드"
      contains: "emitSIPEvent"
    - path: "internal/engine/events.go"
      provides: "WithSIPMessage note 파라미터"
      contains: "note ...string"
    - path: "internal/engine/graph.go"
      provides: "GraphNode TransferTarget 필드"
      contains: "TransferTarget"
    - path: "internal/engine/executor_test.go"
      provides: "SessionStore 이벤트 버스 테스트, AnswerOptions 전환 검증"
      contains: "TestSessionStore_SIPEventBus"
  key_links:
    - from: "internal/engine/executor.go"
      to: "diago.AnswerOptions"
      via: "serverSession.AnswerOptions(opts)"
      pattern: "serverSession\\.AnswerOptions"
    - from: "internal/engine/executor.go"
      to: "internal/engine/engine.go"
      via: "ex.engine.emitSIPEvent(instanceID, eventType)"
      pattern: "emitSIPEvent"
    - from: "internal/engine/engine.go"
      to: "internal/engine/executor.go"
      via: "e.executor.sessions.emitSIPEvent()"
      pattern: "ex\\.sessions\\.emitSIPEvent"
---

<objective>
Phase 10의 Hold/Retrieve 기능을 위한 인프라를 구축한다: executeAnswer() AnswerOptions 리팩토링, SessionStore SIP 이벤트 버스, Engine executor 필드 승격, WithSIPMessage note 파라미터.

Purpose: Hold/Retrieve Command와 HeldEvent/RetrievedEvent 노드 구현의 전제조건. AnswerOptions 콜백 없이는 상대방 Hold/Retrieve를 감지할 수 없고, SIP 이벤트 버스 없이는 이벤트 노드가 블로킹 대기할 수 없다.
Output: AnswerOptions 기반 Answer 실행, SIP 이벤트 구독/발행 인프라, 기존 테스트 통과 + 새 인프라 테스트
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-hold-retrieve-backend/10-RESEARCH.md
@internal/engine/executor.go
@internal/engine/engine.go
@internal/engine/events.go
@internal/engine/graph.go
@internal/engine/executor_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: SessionStore SIP 이벤트 버스 + Engine executor 필드 승격 + WithSIPMessage note + GraphNode 필드</name>
  <files>
    internal/engine/executor.go
    internal/engine/engine.go
    internal/engine/events.go
    internal/engine/graph.go
  </files>
  <action>
**executor.go — SessionStore 확장:**
SessionStore 구조체에 `sipEventSubs map[string][]chan struct{}` 필드 추가.
NewSessionStore()에서 `sipEventSubs: make(map[string][]chan struct{})` 초기화.

세 메서드 추가:
- `emitSIPEvent(instanceID, eventType string)`: RLock으로 키 `"{instanceID}:{eventType}"` 채널들에 non-blocking send
- `SubscribeSIPEvent(instanceID, eventType string) chan struct{}`: Lock으로 버퍼 1 채널 생성, 맵에 append, 채널 반환
- `UnsubscribeSIPEvent(instanceID, eventType string, ch chan struct{})`: Lock으로 슬라이스에서 해당 채널 제거

10-RESEARCH.md 패턴 4 (SessionStore SIP 이벤트 버스) 코드를 그대로 따른다.

**engine.go — executor 필드 승격:**
Engine 구조체에 `executor *Executor` 필드 추가 (`im` 필드 뒤, `mu` 필드 앞).

StartScenario()에서:
- 기존: `executor := NewExecutor(e, e.im)` (로컬 변수)
- 변경: `e.executor = NewExecutor(e, e.im)` (필드 할당)
- 이후 `executor` 참조를 `e.executor`로 변경 (goroutine 클로저, errCh 등)
- cleanup() 호출: `e.cleanup(executor)` → `e.cleanup()` (인자 제거)

cleanup() 메서드 변경:
- 기존: `func (e *Engine) cleanup(executor *Executor)` → `func (e *Engine) cleanup()`
- 내부에서 `executor.sessions` → `e.executor.sessions`
- cleanup 마지막에 `e.mu.Lock(); e.executor = nil; e.mu.Unlock()` 추가 (GC 허용)

emitSIPEvent() 메서드 추가 (events.go가 아닌 engine.go에):
```go
func (e *Engine) emitSIPEvent(instanceID, eventType string) {
    e.mu.Lock()
    ex := e.executor
    e.mu.Unlock()
    if ex != nil {
        ex.sessions.emitSIPEvent(instanceID, eventType)
    }
}
```

**events.go — WithSIPMessage note 파라미터:**
`WithSIPMessage` 시그니처를 variadic note로 확장:
기존: `func WithSIPMessage(direction, method string, responseCode int, callID, from, to string) ActionLogOption`
변경: `func WithSIPMessage(direction, method string, responseCode int, callID, from, to string, note ...string) ActionLogOption`

함수 본문에서 `if len(note) > 0 && note[0] != "" { msg["note"] = note[0] }` 추가.
variadic이므로 기존 호출 코드 변경 없음.

**graph.go — GraphNode TransferTarget 필드:**
GraphNode 구조체에 `TransferTarget string` 필드 추가 (BlindTransfer 대상 URI — Phase 11 대비).
`Timeout` 필드 뒤에 배치.
ParseScenario()의 command 파싱 블록에서 `gnode.TransferTarget = getStringField(node.Data, "transferTarget", "")` 추가.
  </action>
  <verify>
`cd /home/overthinker/Project/sipflow && go build ./...` — 컴파일 성공.
`go vet ./internal/engine/...` — 경고 없음.
기존 테스트: `go test ./internal/engine/ -run "TestExecuteChain|TestSessionStore_StoreAndGet|TestSessionStore_ThreadSafety" -v` — 모두 통과.
  </verify>
  <done>
SessionStore에 sipEventSubs 맵과 emit/Subscribe/Unsubscribe 메서드가 존재한다. Engine에 executor 필드와 emitSIPEvent() 메서드가 존재한다. WithSIPMessage가 note 파라미터를 지원하면서 기존 호출이 깨지지 않는다. GraphNode에 TransferTarget 필드가 존재한다. `go build ./...`와 기존 테스트가 모두 통과한다.
  </done>
</task>

<task type="auto">
  <name>Task 2: executeAnswer() AnswerOptions 리팩토링 + 인프라 테스트</name>
  <files>
    internal/engine/executor.go
    internal/engine/executor_test.go
  </files>
  <action>
**executor.go — executeAnswer() 리팩토링:**

기존 `executeAnswer()`를 AnswerOptions 기반으로 변경. 10-RESEARCH.md 패턴 3 코드를 따른다.

핵심 변경:
1. `serverSession.Answer()` → `serverSession.AnswerOptions(opts)` 호출
2. `diago.AnswerOptions{}` 구성:
   - `OnMediaUpdate: func(d *diago.DialogMedia)` — **반드시 goroutine으로 분리** (데드락 방지, RESEARCH 함정 2)
     - goroutine 안에서 `d.MediaSession().LocalSDP()` 호출하여 string으로 변환
     - `strings.Contains(localSDP, "a=recvonly")` → `ex.engine.emitSIPEvent(instanceID, "HELD")` + emitActionLog
     - `strings.Contains(localSDP, "a=sendrecv")` → `ex.engine.emitSIPEvent(instanceID, "RETRIEVED")` + emitActionLog
     - `defer recover()` 래핑으로 패닉 방어 (RESEARCH 함정 3)
   - `OnRefer: func(referDialog *diago.DialogClientSession) error` — Phase 11 대비 스텁
     - `ex.engine.emitSIPEvent(instanceID, "TRANSFERRED")` + emitActionLog
     - `return nil`
3. 기존 에러 처리 로직 (codec negotiation 감지) 완전히 유지
4. `StoreDialog`, FromUser/ToUser 로그 등 나머지 코드 유지

파일 상단 import에 `"strings"` 확인 (이미 있음). diago import 확인 (`"github.com/emiago/diago"`).

**중요:** `OnMediaUpdate` 콜백에서 `d.MediaSession()` 호출은 반드시 goroutine 안에서. 콜백은 `d.mu.Lock()` 안에서 호출되므로 `d.MediaSession()`(내부에서 `d.mu.Lock()` 재진입)을 직접 호출하면 데드락.

**executor_test.go — 새 테스트 추가:**

1. `TestSessionStore_SIPEventBus` — 이벤트 발행/구독 테스트:
   - `NewSessionStore()` 생성
   - `SubscribeSIPEvent("inst1", "HELD")` → 채널 수신
   - goroutine으로 50ms 후 `emitSIPEvent("inst1", "HELD")` 호출
   - select로 채널 수신 확인 (1초 타임아웃)
   - `UnsubscribeSIPEvent` 호출 후 재발행 → 수신 안 됨 확인

2. `TestSessionStore_SIPEventBus_MultipleSubscribers` — 다중 구독자:
   - 같은 이벤트에 2개 채널 구독
   - 한 번 emit → 두 채널 모두 수신

3. `TestSessionStore_SIPEventBus_NoSubscribers` — 구독자 없을 때:
   - 구독 없이 `emitSIPEvent` 호출 → 패닉 없이 완료

4. `TestExecuteHold_NoDialog` — Hold 에러 경로 (Plan 02 선행 준비용 제외 — Plan 02에서 추가):
   건너뛰기. Plan 02에서 Hold/Retrieve 함수와 함께 테스트 추가.

5. `TestWithSIPMessage_Note` — note 파라미터 테스트:
   - `WithSIPMessage("sent", "INVITE", 200, "", "", "", "sendonly")` 호출
   - data map에 `sipMessage.note == "sendonly"` 확인

6. `TestWithSIPMessage_NoNote` — note 없이 기존 호환성:
   - `WithSIPMessage("sent", "INVITE", 200, "", "", "")` 호출 (기존 6개 인자)
   - data map에 `sipMessage.note` 키 없음 확인
  </action>
  <verify>
전체 테스트: `cd /home/overthinker/Project/sipflow && go test ./internal/engine/ -v` — 모든 테스트 통과.
`go build ./...` — 컴파일 성공.
새 테스트 확인: `go test ./internal/engine/ -run "TestSessionStore_SIPEventBus|TestWithSIPMessage" -v` — 통과.
  </verify>
  <done>
executeAnswer()가 AnswerOptions를 사용하여 OnMediaUpdate(goroutine 분리 포함)와 OnRefer 콜백을 등록한다. SessionStore SIP 이벤트 버스의 발행/구독/해제가 테스트로 검증된다. WithSIPMessage note 파라미터가 하위 호환성과 함께 테스트된다. `go test ./internal/engine/`의 모든 기존 + 신규 테스트가 통과한다.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` — 전체 프로젝트 컴파일 성공
2. `go test ./internal/engine/ -v` — 모든 테스트 통과 (기존 + 신규)
3. `go vet ./internal/engine/...` — 경고 없음
4. grep으로 핵심 연결 확인:
   - `grep -n "AnswerOptions" internal/engine/executor.go` — AnswerOptions 사용 확인
   - `grep -n "emitSIPEvent" internal/engine/engine.go` — emitSIPEvent 메서드 존재
   - `grep -n "sipEventSubs" internal/engine/executor.go` — 이벤트 버스 필드 존재
   - `grep -n "note ...string" internal/engine/events.go` — note 파라미터 존재
   - `grep -n "TransferTarget" internal/engine/graph.go` — TransferTarget 필드 존재
</verification>

<success_criteria>
- executeAnswer()가 serverSession.AnswerOptions()를 호출한다
- OnMediaUpdate 콜백이 goroutine 안에서 LocalSDP()를 파싱하여 HELD/RETRIEVED를 감지한다
- SessionStore.emitSIPEvent/SubscribeSIPEvent/UnsubscribeSIPEvent가 동작한다
- Engine.emitSIPEvent()가 executor.sessions.emitSIPEvent()를 중계한다
- WithSIPMessage가 variadic note를 지원하면서 기존 호출이 깨지지 않는다
- GraphNode에 TransferTarget 필드가 존재한다
- go build와 go test가 모두 통과한다
</success_criteria>

<output>
완료 후, `.planning/phases/10-hold-retrieve-backend/10-01-SUMMARY.md` 생성
</output>
