---
phase: 06
plan: "06-01"
title: "Backend 코덱 데이터 모델 + diago 통합"
wave: 1
depends_on: []
files_modified:
  - internal/engine/graph.go
  - internal/engine/graph_test.go
  - internal/engine/instance_manager.go
  - internal/engine/executor.go
autonomous: true
estimated_effort: "medium"
requirement_ids: ["CODEC-01"]
---

# 06-01: Backend 코덱 데이터 모델 + diago 통합

<context>
현재 SipInstanceConfig에는 코덱 관련 필드가 없다. 모든 diago 인스턴스가 diago 기본 코덱(PCMU, PCMA, telephone-event)으로 생성되며, 사용자가 인스턴스별 코덱을 제어할 수 없다.

이 계획에서는 프론트엔드 시나리오 JSON의 코덱 데이터를 파싱하여 diago UA 생성 시 WithMediaConfig()로 적용하는 백엔드 파이프라인을 구축한다.

의존성 없음 — 프론트엔드 계획(06-02)과 병렬 진행 가능.
</context>

<task>
## 목표
SipInstanceConfig에 Codecs 필드를 추가하고, ParseScenario에서 JSON의 codecs 배열을 파싱하며, CreateInstances에서 diago.WithMediaConfig()를 통해 인스턴스별 코덱 설정을 적용한다. 또한 executor.go의 Answer 명령에서 코덱 협상 실패(488 Not Acceptable)를 감지하고 에러 로깅한다.

## 구현 상세

### 단계 1: graph.go — SipInstanceConfig에 Codecs 필드 추가

1. `SipInstanceConfig` 구조체에 `Codecs []string` 필드를 추가한다:
   ```go
   type SipInstanceConfig struct {
       ID       string
       Label    string
       Mode     string // DN|Endpoint
       DN       string
       Register bool
       Color    string
       Codecs   []string // ["PCMU", "PCMA"] — 사용자 선택 코덱 (우선순위 순서)
   }
   ```

2. `getStringArrayField()` 헬퍼 함수를 추가한다:
   ```go
   func getStringArrayField(data map[string]interface{}, key string, defaultVal []string) []string {
       if val, ok := data[key]; ok {
           if arr, ok := val.([]interface{}); ok {
               result := make([]string, 0, len(arr))
               for _, v := range arr {
                   if s, ok := v.(string); ok {
                       result = append(result, s)
                   }
               }
               if len(result) > 0 {
                   return result
               }
           }
       }
       return defaultVal
   }
   ```
   - JSON `[]interface{}` → `[]string` 안전 변환
   - 빈 배열이면 기본값 반환 (코덱 미설정 시 기본값 적용 보장)

3. `ParseScenario()` 함수의 sipInstance 파싱 블록에서 `Codecs` 필드를 파싱한다:
   ```go
   config := SipInstanceConfig{
       // ... 기존 필드들 ...
       Codecs: getStringArrayField(node.Data, "codecs", []string{"PCMU", "PCMA"}),
   }
   ```
   - 기본값 `["PCMU", "PCMA"]`: v1.0 시나리오(codecs 필드 없음) 하위 호환성 보장

### 단계 2: instance_manager.go — stringToCodecs 헬퍼 + WithMediaConfig 적용

1. `"github.com/emiago/diago/media"` import를 추가한다.

2. `stringToCodecs()` 헬퍼 함수를 추가한다:
   ```go
   func stringToCodecs(codecNames []string) []media.Codec {
       codecs := make([]media.Codec, 0, len(codecNames)+1)
       for _, name := range codecNames {
           switch name {
           case "PCMU":
               codecs = append(codecs, media.CodecAudioUlaw)
           case "PCMA":
               codecs = append(codecs, media.CodecAudioAlaw)
           }
       }
       // telephone-event는 항상 마지막에 추가 (DTMF 지원)
       codecs = append(codecs, media.CodecTelephoneEvent8000)
       return codecs
   }
   ```
   - 알 수 없는 코덱 이름은 무시 (안전 처리)
   - telephone-event(101)는 사용자 선택과 무관하게 항상 포함
   - 코덱 순서 = 사용자가 설정한 우선순위 순서 → SDP m= 라인 순서 결정

3. `CreateInstances()` 메서드에서 `diago.NewDiago()` 호출 시 `diago.WithMediaConfig()`를 추가한다:
   ```go
   // 코덱 문자열 → media.Codec 변환
   codecs := stringToCodecs(chain.Config.Codecs)

   // diago 인스턴스 생성
   dg := diago.NewDiago(ua,
       diago.WithTransport(diago.Transport{
           Transport: "udp",
           BindHost:  "127.0.0.1",
           BindPort:  port,
       }),
       diago.WithMediaConfig(diago.MediaConfig{
           Codecs: codecs,
       }),
   )
   ```

### 단계 3: graph_test.go — 코덱 파싱 테스트 추가

1. `TestParseScenario_CodecsField` 테스트를 추가한다:
   - 시나리오 JSON에 `"codecs": ["PCMA", "PCMU"]`를 포함한 sipInstance 노드 생성
   - ParseScenario 호출 후 `config.Codecs`가 `["PCMA", "PCMU"]` 순서로 파싱되는지 검증

2. `TestParseScenario_CodecsDefault` 테스트를 추가한다:
   - codecs 필드가 없는 sipInstance 노드 (v1.0 호환)
   - ParseScenario 호출 후 `config.Codecs`가 기본값 `["PCMU", "PCMA"]`인지 검증

3. `TestParseScenario_CodecsEmpty` 테스트를 추가한다:
   - `"codecs": []` (빈 배열) 입력 시 기본값 `["PCMU", "PCMA"]`로 폴백 검증

4. `TestParseScenario_CodecsInvalid` 테스트를 추가한다:
   - `"codecs": ["INVALID", "PCMU"]` 입력 시 파싱은 성공하고 `config.Codecs`가 `["INVALID", "PCMU"]`로 저장되는지 검증
   - 잘못된 코덱 이름의 필터링은 `stringToCodecs()` 단계에서 처리되므로, 파싱 단계에서는 원본 문자열을 보존함을 확인

### 단계 4: executor.go — 코덱 협상 실패(488) 감지 + 에러 로깅

diago v0.27.0은 코덱 협상 실패 시 자동으로 488 Not Acceptable을 전송하지 않는다. `serverSession.Answer()` 호출 시 양측 SDP의 코덱이 교집합이 없으면 diago가 내부적으로 에러를 반환한다. 이를 명시적으로 감지하여 사용자에게 의미 있는 에러 메시지를 제공해야 한다.

1. `executeAnswer()` 함수에서 `serverSession.Answer()` 에러를 분석하여 코덱 협상 실패를 감지한다:
   ```go
   // Answer 호출
   if err := serverSession.Answer(); err != nil {
       // 코덱 협상 실패 감지 (에러 메시지에 "codec" 또는 "media" 관련 문자열 포함 여부)
       errMsg := err.Error()
       if strings.Contains(strings.ToLower(errMsg), "codec") ||
           strings.Contains(strings.ToLower(errMsg), "media") ||
           strings.Contains(strings.ToLower(errMsg), "negotiat") {
           ex.engine.emitActionLog(node.ID, instanceID,
               fmt.Sprintf("Codec negotiation failed (488 Not Acceptable): %v", err), "error")
           return fmt.Errorf("codec negotiation failed (488 Not Acceptable): %w", err)
       }
       return fmt.Errorf("Answer failed: %w", err)
   }
   ```

2. 코덱 협상 실패 시 로그에 인스턴스의 설정된 코덱 목록을 포함한다:
   ```go
   // 인스턴스 코덱 정보 조회 (디버깅용)
   instance, instErr := ex.im.GetInstance(instanceID)
   if instErr == nil {
       ex.engine.emitActionLog(node.ID, instanceID,
           fmt.Sprintf("Instance codecs: %v", instance.Config.Codecs), "debug")
   }
   ```

3. 이 로직은 기존 `executeAnswer()` 함수 내에서 `serverSession.Answer()` 에러 처리 블록을 확장하는 형태로 구현한다. 새로운 함수나 파일을 추가하지 않는다.

**참고**: diago의 Answer() 에러가 코덱 협상 실패를 구체적으로 구분하지 않을 수 있다. 이 경우 모든 Answer 실패에 대해 인스턴스 코덱 정보를 디버그 로그로 함께 출력하여, 사용자가 원인을 파악할 수 있도록 한다.

## 검증
- [ ] `go build ./...` 성공
- [ ] `go test ./internal/engine/...` 전체 통과
- [ ] codecs 필드가 있는 JSON 파싱 시 올바른 순서로 Codecs 설정됨
- [ ] codecs 필드가 없는 기존 JSON 파싱 시 기본값 ["PCMU", "PCMA"] 적용됨
- [ ] 빈 codecs 배열 입력 시 기본값으로 폴백됨
- [ ] 잘못된 코덱 이름 입력 시 파싱은 성공하고 stringToCodecs()에서 무시됨
- [ ] stringToCodecs()가 항상 telephone-event를 마지막에 포함
- [ ] CreateInstances()에서 WithMediaConfig()가 적용됨
- [ ] Answer 실패 시 코덱 협상 실패 여부가 감지되고 에러 메시지에 "488 Not Acceptable" 포함
- [ ] Answer 실패 시 인스턴스 코덱 정보가 디버그 로그에 포함됨
</task>

<must_haves>
- SipInstanceConfig.Codecs 필드가 시나리오 JSON에서 파싱됨
- 기본값 ["PCMU", "PCMA"]가 codecs 필드 미설정 시 적용됨 (v1.0 하위 호환)
- stringToCodecs()가 telephone-event를 항상 마지막에 자동 포함
- diago.WithMediaConfig()가 CreateInstances()에서 인스턴스별로 적용됨
- 코덱 순서가 사용자 설정 우선순위 그대로 SDP에 반영되는 파이프라인 완성
- executeAnswer()에서 코덱 협상 실패 시 명확한 에러 메시지("488 Not Acceptable") 반환
- 잘못된 코덱 이름(예: "INVALID") 입력 시 파싱은 성공하고 stringToCodecs()에서 무시됨
</must_haves>
