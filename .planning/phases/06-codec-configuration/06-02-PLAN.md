---
phase: 06
plan: "06-02"
title: "Frontend 코덱 선택 UI + 노드 표시"
wave: 1
depends_on: []
files_modified:
  - frontend/src/features/scenario-builder/types/scenario.ts
  - frontend/src/features/scenario-builder/components/properties/sip-instance-properties.tsx
  - frontend/src/features/scenario-builder/components/properties/codec-list-item.tsx
  - frontend/src/features/scenario-builder/components/nodes/sip-instance-node.tsx
  - frontend/src/features/scenario-builder/components/canvas.tsx
autonomous: true
estimated_effort: "medium"
requirement_ids: ["CODEC-01"]
---

# 06-02: Frontend 코덱 선택 UI + 노드 표시

<context>
현재 SipInstanceNodeData에는 코덱 관련 필드가 없다. Properties 패널에도 코덱 선택 UI가 없으며, SIP Instance 노드에도 코덱 정보가 표시되지 않는다.

이 계획에서는 사용자가 드래그로 코덱 우선순위를 변경할 수 있는 UI를 구축하고, 캔버스 노드에 선택된 코덱을 표시한다. v1.1에서 코덱이 PCMU/PCMA 2개뿐이므로 체크박스 토글 없이 드래그 순서 변경만 지원한다.

의존성 없음 — 백엔드 계획(06-01)과 병렬 진행 가능. 프론트엔드 타입과 UI만 다루며, 백엔드 API 변경 없이 기존 flowData JSON 구조에 codecs 필드를 추가하는 것만으로 통합됨.
</context>

<task>
## 목표
SipInstanceNodeData에 codecs 필드를 추가하고, Properties 패널에 드래그 기반 코덱 우선순위 변경 UI를 구현하며, SIP Instance 노드에 선택된 코덱을 배지로 표시한다. v1.1에서 코덱이 PCMU/PCMA 2개뿐이므로 체크박스 토글은 제거하고 드래그 순서 변경만 지원한다.

## 구현 상세

### 단계 1: scenario.ts — 타입 + 상수 추가

1. `SipInstanceNodeData` 인터페이스에 `codecs` 필드를 추가한다:
   ```typescript
   export interface SipInstanceNodeData extends Record<string, unknown> {
     label: string;
     mode: 'DN' | 'Endpoint';
     dn?: string;
     register: boolean;
     serverId?: string;
     color: string;
     codecs?: string[];  // ["PCMU", "PCMA"] — 코덱 우선순위 순서
   }
   ```

2. 코덱 관련 상수를 추가한다:
   ```typescript
   // Available codecs for SIP instances
   export const AVAILABLE_CODECS = ['PCMU', 'PCMA'] as const;

   // Default codec selection (all codecs enabled, PCMU first)
   export const DEFAULT_CODECS: string[] = ['PCMU', 'PCMA'];
   ```

### 단계 2: canvas.tsx — 새 SIP Instance 노드 기본 코덱 설정

`onDrop` 핸들러의 sipInstance 노드 생성 블록에 `codecs` 기본값을 추가한다:
```typescript
if (dragType === 'sipInstance') {
  const instanceCount = nodes.filter((n) => n.type === 'sipInstance').length;
  nodeType = 'sipInstance';
  nodeData = {
    label: 'SIP Instance',
    mode: 'DN',
    register: true,
    color: INSTANCE_COLORS[instanceCount % INSTANCE_COLORS.length],
    codecs: [...DEFAULT_CODECS],  // 기본 코덱 설정
  };
}
```
- 기존 import 문을 수정하여 `DEFAULT_CODECS`를 추가한다:
  ```typescript
  import { INSTANCE_COLORS, DEFAULT_CODECS } from '../types/scenario';
  ```
- 스프레드 연산자로 새 배열 생성 (참조 공유 방지)

### 단계 3: codec-list-item.tsx — 드래그 가능한 코덱 항목 컴포넌트 (신규 파일)

`frontend/src/features/scenario-builder/components/properties/codec-list-item.tsx` 파일을 생성한다.

```typescript
import { useState } from 'react';
import { GripVertical } from 'lucide-react';
import { cn } from '@/lib/utils';
```

컴포넌트 인터페이스:
```typescript
interface CodecListItemProps {
  codec: string;
  index: number;
  onMove: (fromIndex: number, toIndex: number) => void;
}
```

**참고**: v1.1에서 코덱은 PCMU/PCMA 2개뿐이므로 체크박스 토글(활성화/비활성화)은 구현하지 않는다. 2개 코덱에 체크박스 + 드래그를 동시 제공하면 UX가 혼란스럽고, 성공 기준은 "드래그로 우선순위 변경"만 요구한다. 모든 코덱이 항상 활성 상태이며, 드래그로 순서만 변경한다.

구현 핵심:
1. HTML5 Drag and Drop API 사용 (프로젝트 기존 패턴 — node-palette.tsx 참조)
2. **`nodrag` 클래스 필수** — React Flow 노드 드래그와 충돌 방지 (Properties 패널이 `nodrag` 클래스 아래에 있으나, 코덱 아이템 자체에도 명시)
3. `draggable` 속성과 `onDragStart`, `onDragOver`, `onDrop`, `onDragEnd` 핸들러
4. `e.dataTransfer.setData('text/plain', index.toString())` 로 드래그 인덱스 전달
5. `e.dataTransfer.effectAllowed = 'move'` 설정
6. 드래그 중 `opacity-50` 시각 피드백
7. 드래그 오버 시 `bg-accent` 하이라이트 (onDragEnter/onDragLeave로 상태 관리)

레이아웃:
```
[GripVertical] [코덱 이름] [페이로드 타입]
```

- GripVertical 아이콘: 드래그 핸들 시각적 표시
- 코덱 이름: "PCMU" 또는 "PCMA"
- 페이로드 타입: 작은 텍스트로 "(0)" 또는 "(8)" 표시 — 참고용

### 단계 4: sip-instance-properties.tsx — 코덱 선택 섹션 추가

Properties 패널의 Color Picker 섹션 아래에 코덱 선택 섹션을 추가한다.

1. import 추가:
   ```typescript
   import { CodecListItem } from './codec-list-item';
   import { DEFAULT_CODECS } from '../../types/scenario';
   ```

2. 코덱 상태 관리 로직:
   - `data.codecs && data.codecs.length > 0 ? data.codecs : DEFAULT_CODECS` 표현을 사용하여 `undefined`와 빈 배열 모두 안전하게 기본값으로 폴백 (v1.0 호환)
   - 모든 코덱이 항상 활성 상태이며, 드래그로 순서만 변경

3. 코덱 이동 핸들러 (`moveCodec`):
   ```typescript
   const moveCodec = (fromIndex: number, toIndex: number) => {
     const currentCodecs = data.codecs && data.codecs.length > 0
       ? data.codecs
       : [...DEFAULT_CODECS];
     const newCodecs = [...currentCodecs];
     const [removed] = newCodecs.splice(fromIndex, 1);
     newCodecs.splice(toIndex, 0, removed);
     onUpdate({ codecs: newCodecs });
   };
   ```

4. 렌더링 구조:
   ```
   ── Separator ──
   Preferred Codecs
   "Drag to reorder priority."
   ┌────────────────────────────┐
   │ ≡ PCMU (0)                │  ← 드래그 가능
   │ ≡ PCMA (8)                │  ← 드래그 가능
   └────────────────────────────┘
   ```
   - 코덱 리스트를 `data.codecs` 순서대로 표시
   - 각 아이템은 `CodecListItem` 컴포넌트로 렌더링, `onMove` 핸들러만 전달

### 단계 5: sip-instance-node.tsx — 코덱 배지 표시

SIP Instance 노드 컴포넌트의 하단 영역에 코덱 정보를 표시한다.

기존 DN 표시 영역(`{data.mode === 'DN' && data.dn && ...}`) 아래에 추가:
```typescript
{/* Codec display */}
<div className="text-xs text-muted-foreground mt-1">
  {(data.codecs && data.codecs.length > 0 ? data.codecs : DEFAULT_CODECS).join(', ')}
</div>
```

- `DEFAULT_CODECS`를 `'../../types/scenario'`에서 임포트:
  ```typescript
  import { DEFAULT_CODECS } from '../../types/scenario';
  ```
- `data.codecs && data.codecs.length > 0` 표현을 사용하여 `undefined`와 빈 배열 모두 안전하게 기본값으로 폴백
- codecs 필드가 없거나 빈 배열이면 기본값 표시 ("PCMU, PCMA")

## 검증
- [ ] `npm run build` (또는 `npx tsc --noEmit`) 타입 에러 없이 성공
- [ ] 새 SIP Instance 노드 드롭 시 기본 코덱 ["PCMU", "PCMA"] 설정됨
- [ ] Properties 패널에서 코덱 아이템 드래그로 우선순위 변경 가능
- [ ] 드래그 시 React Flow 노드가 함께 움직이지 않음 (nodrag 클래스 동작)
- [ ] SIP Instance 노드에 선택된 코덱이 텍스트로 표시됨
- [ ] 코덱 변경 시 autosave 트리거됨 (isDirty → debouncedSave)
- [ ] 기존 시나리오(codecs 필드 없음) 로드 시 기본값으로 정상 렌더링
- [ ] 빈 codecs 배열([]) 시 기본값으로 안전하게 폴백됨
- [ ] 시나리오 저장 후 재로드 시 코덱 순서 상태 유지
</task>

<must_haves>
- SipInstanceNodeData.codecs 필드가 optional string[]로 추가됨
- DEFAULT_CODECS 상수 ["PCMU", "PCMA"]가 정의되고 일관되게 사용됨
- Properties 패널에서 드래그로 코덱 우선순위 변경 가능 (체크박스 토글 없음 — 드래그 전용)
- codec-list-item.tsx에 nodrag 클래스가 적용되어 React Flow 충돌 방지
- 새 SIP Instance 노드 생성 시 기본 코덱이 자동 설정됨
- SIP Instance 노드 캔버스에 선택된 코덱이 표시됨
- canvas.tsx에 `import { INSTANCE_COLORS, DEFAULT_CODECS } from '../types/scenario'` 명시적 import
- `data.codecs && data.codecs.length > 0 ? data.codecs : DEFAULT_CODECS` 패턴으로 undefined와 빈 배열 모두 안전하게 폴백
- v1.0 시나리오(codecs 필드 없음) 로드 시 기본값으로 정상 동작 (하위 호환)
</must_haves>
