# Phase 02 Context: 시나리오 빌더 — 캔버스 및 노드 시스템

> XYFlow 기반 노드 에디터 핵심 구현

## 논의된 영역

1. [노드 타입 및 시각 디자인](#1-노드-타입-및-시각-디자인)
2. [캔버스 레이아웃 및 인터랙션](#2-캔버스-레이아웃-및-인터랙션)
3. [SIP 인스턴스 모델 및 할당 UX](#3-sip-인스턴스-모델-및-할당-ux)
4. [시나리오 직렬화 및 검증](#4-시나리오-직렬화-및-검증)

---

## 1. 노드 타입 및 시각 디자인

### 결정사항

**노드 카테고리:** 3종류 — SIP Instance, Command, Event

**SIP Instance 노드 (플로우 시작점):**
- SIP 인스턴스 노드가 각 플로우의 시작점 역할
- 내선(DN) 방식: DN + Register 옵션 필요
- Endpoint 방식: SIP 서버 목록에서 선택, Register 불필요
- Ready 커맨드는 인스턴스 노드 내부 동작으로 통합됨

**Command 노드 (MVP Phase 2 기본):**
- Ready — SIP 인스턴스 준비 (인스턴스 노드에 포함)
- MakeCall — INVITE 전달 (발신)
- Answer — 200 OK 전달 (응답)
- Release — Cancel/BYE 전달 (종료)

**Command 노드 (이후 Phase에서 추가):**
- Ringing — 100→180 전달
- Hold — 통화 보류
- Retrieve — 보류 해제
- Single Transfer — Blind Transfer
- Mute Transfer — Hold 후 협의 호전환
- Response — 486, 603 등 응답 코드 전달

**Event 노드 (전체):**
- INCOMING — 수신 통화 대기 (INVITE 수신)
- DISCONNECTED — 통화 종료 감지 (BYE 수신)
- RINGING — 링 응답 수신 (180 Ringing)
- TIMEOUT — 타이머 기반 대기
- HELD — 상대방이 Hold 했을 때
- RETRIEVED — 상대방이 Retrieve 했을 때
- TRANSFERRED — Transfer 완료 이벤트
- NOTIFY — SIP NOTIFY 수신

**프로토콜 추상화 전략:**
- SIP 프로토콜 메시지명 대신 추상화된 액션명 사용 (MakeCall, Release 등)
- 향후 CSTA 구현체와 통합 시 동일한 노드명 유지 가능

### 시각 디자인

**시각 구분:** 색상 + 모양으로 구분
- Command 노드: 파란 계열 직사각형
- Event 노드: 노란 계열 둥근 모서리
- SIP Instance 노드: 별도 시각적 스타일 (시작점 표현)

**노드 내부 정보량:** 중간
- 액션명 + 핵심 속성 1-2개 표시
- 예: MakeCall 노드에 대상 DN 표시
- 상세 속성은 우측 속성 패널에서 편집

**핸들(포트) 배치:** 상→하 플로우
- 상단: 입력 핸들 1개
- 하단: 성공(녹색) + 실패(빨간색) 출력 핸들 2개
- 플로우차트처럼 위에서 아래로 흐름

---

## 2. 캔버스 레이아웃 및 인터랙션

### 결정사항

**전체 레이아웃:** 3칸 구조
- 좌측 (~200px): 노드 팔레트 + 프로젝트/시나리오 트리
- 중앙: XYFlow 캔버스
- 우측 (~280px): 노드 속성 편집 패널
- 상단: 툴바

**좌측 사이드바 구성:**
- 상단: 프로젝트/시나리오 파일 트리 (animate-ui.com의 Files 트리 컴포넌트 사용)
- 하단: 노드 팔레트 (Command/Event 노드 목록)

**노드 추가 방식:** 드래그 앤 드롭
- 좌측 팔레트에서 노드를 드래그하여 캔버스에 드롭

**캔버스 배경:** 도트 그리드
- 점 패턴 그리드 배경 (깔끔하고 모던한 느낌)

**속성 패널:** 노드별 전용 폼
- 노드 선택 시 우측 패널에 해당 노드 타입에 맞는 전용 폼 표시
- MakeCall: 대상 URI, 타임아웃 등
- Answer: 응답 코드 등
- 노드 미선택 시: 빈 상태 또는 시나리오 전체 속성

---

## 3. SIP 인스턴스 모델 및 할당 UX

### 결정사항

**인스턴스 정의 방식:** 노드로 관리
- SIP 인스턴스가 캔버스의 노드로 존재 (별도 패널이 아님)
- 인스턴스 노드 = 플로우 시작점
- 하나의 시나리오에 보통 2-3개 인스턴스 (발신/수신 + 선택적 중계)

**인스턴스 유형:**
- 내선(DN) 방식: DN 번호 + Register 옵션 ON → SIP 서버에 등록
- Endpoint 방식: Register 옵션 OFF → SIP 서버 목록에서 접속할 서버 선택

**SIP 서버 설정:**
- 별도 설정 페이지에서 관리 (Phase 2에서 기본 구현)
- SIP 서버 목록(URI, Transport) 관리

**노드에 인스턴스 할당:**
- 속성 패널 드롭다운으로 해당 노드가 어떤 인스턴스에 속하는지 선택
- 캔버스에서 인스턴스별 색상으로 시각 구분

**인스턴스별 색상 구분:**
- 노드 테두리(border) 색상이 할당된 인스턴스의 색상을 반영
- 인스턴스마다 고유 색상 자동 할당

---

## 4. 시나리오 직렬화 및 검증

### 결정사항

**저장소:** SQLite
- 프로젝트 → 시나리오 계층 구조
- 하나의 프로젝트 안에 여러 시나리오 포함
- 프로젝트 실행 시 시나리오들이 순차 실행

**DB 구조:** (연구 단계에서 구체화)
- 프로젝트 테이블
- 시나리오 테이블 (프로젝트 하위)
- 시나리오 내 노드/엣지 JSON 저장 방식은 연구에서 결정

**Phase 2 범위:**
- 단일 프로젝트로 작업 (프로젝트 CRUD는 이후 Phase)
- 시나리오 CRUD 구현
- 파일 내보내기/가져오기는 이후 Phase

**시나리오 목록:** 간단한 목록 UI
- 좌측 트리에서 시나리오 목록 보기/선택/삭제
- animate-ui.com의 Files 트리 컴포넌트 사용

**검증 시점:** 실시간 + 저장 시
- 엣지 연결 시 실시간 순환 감지
- 저장 시 전체 검증

**검증 규칙 (MVP):**
1. 순환 감지 — DAG 위반 방지
2. 고립 노드 감지 — 연결되지 않은 노드 경고
3. 필수 속성 검증 — 노드별 필수 속성이 채워졌는지 확인
4. 인스턴스 할당 검증 — 모든 노드에 SIP 인스턴스가 할당되었는지 확인

**오류 표시:** 노드 하이라이트 + 토스트
- 문제 노드를 빨간 테두리로 하이라이트
- 우하단 토스트 메시지로 오류 내용 표시

---

## 미뤄진 아이디어

| 아이디어 | 출처 | 비고 |
|----------|------|------|
| 프로젝트 CRUD UI | Phase 2 논의 | Phase 2는 단일 프로젝트, CRUD는 이후 |
| Hold, Retrieve, Transfer 등 고급 Command | Phase 2 논의 | 기본 4개만 Phase 2, 나머지 이후 Phase |
| Ringing, Response Command 노드 | Phase 2 논의 | 이후 Phase |
| 파일 내보내기/가져오기 (.json) | Phase 2 논의 | Phase 5에서 구현 |

---

## 다음 단계

이 CONTEXT.md를 기반으로:
1. `/prp:plan-phase 2` — Phase 2의 상세 실행 계획(PLAN.md) 생성
