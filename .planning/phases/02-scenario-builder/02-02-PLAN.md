---
phase: 02-scenario-builder
plan: 02
title: "Go backend — SQLite repository + Wails scenario binding"
wave: 1
depends_on: []
files_modified:
  - internal/scenario/repository.go
  - internal/scenario/model.go
  - internal/scenario/repository_test.go
  - internal/binding/scenario_binding.go
  - app.go
  - main.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "SQLite database is created automatically on app startup"
    - "Scenarios can be saved with JSON flow data to SQLite"
    - "Scenarios can be loaded, listed, and deleted via Wails bindings"
    - "Database schema supports project-scenario hierarchy"
  artifacts:
    - path: "internal/scenario/model.go"
      provides: "Go struct definitions for Scenario and Project"
      exports: ["Scenario", "Project"]
    - path: "internal/scenario/repository.go"
      provides: "SQLite CRUD operations for scenarios"
      exports: ["Repository", "NewRepository"]
    - path: "internal/scenario/repository_test.go"
      provides: "Unit tests for repository CRUD"
    - path: "internal/binding/scenario_binding.go"
      provides: "Wails binding exposing scenario operations to frontend"
      exports: ["ScenarioBinding", "NewScenarioBinding"]
  key_links:
    - from: "internal/binding/scenario_binding.go"
      to: "internal/scenario/repository.go"
      via: "ScenarioBinding holds *Repository and delegates CRUD"
    - from: "main.go"
      to: "internal/binding/scenario_binding.go"
      via: "Bind array includes scenarioBinding"
    - from: "app.go"
      to: "internal/binding/scenario_binding.go"
      via: "startup() calls scenarioBinding.SetContext(ctx)"
---

# Plan 02-02: Go backend — SQLite repository + Wails scenario binding

## Objective

Implement the Go backend for scenario persistence using modernc.org/sqlite (CGo-free). Create the SQLite repository with CRUD operations, domain models, unit tests, and the Wails binding that exposes these operations to the frontend.

Purpose: The frontend needs a backend to save/load/list/delete scenarios. This plan delivers the complete backend data layer independently of the frontend work.

Output: Working Wails bindings that the frontend can call to persist scenarios to SQLite. Auto-generated TypeScript bindings in `frontend/wailsjs/`.

## Tasks

<task id="02-T1">

### Task 1: Create Go domain models + SQLite repository with tests

**Files to create:**
- `internal/scenario/model.go`
- `internal/scenario/repository.go`
- `internal/scenario/repository_test.go`

**Action:**

1. Install modernc.org/sqlite dependency:
   ```bash
   cd /Users/kyh0703/Project/sipflow && go get modernc.org/sqlite && go mod tidy
   ```

2. Create `internal/scenario/model.go`:
   - Package `scenario`
   - `Project` struct: ID (string, UUID), Name (string), CreatedAt (time.Time), UpdatedAt (time.Time)
   - `Scenario` struct: ID (string, UUID), ProjectID (string), Name (string), FlowData (string, JSON), CreatedAt (time.Time), UpdatedAt (time.Time)
   - `ScenarioListItem` struct: ID, ProjectID, Name, CreatedAt, UpdatedAt (no FlowData, for list queries)

3. Create `internal/scenario/repository.go`:
   - Package `scenario`
   - Import `database/sql`, `fmt`, `_ "modernc.org/sqlite"`
   - `Repository` struct with `db *sql.DB`
   - `NewRepository(dbPath string) (*Repository, error)`:
     - Open SQLite with `sql.Open("sqlite", dsn)` where `dsn = fmt.Sprintf("file:%s?_pragma=foreign_keys(1)", dbPath)`
     - Call `initTables()` to create schema
     - Return repository
   - `initTables()` creates:
     - `projects` table: id TEXT PRIMARY KEY, name TEXT NOT NULL, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
     - `scenarios` table: id TEXT PRIMARY KEY, project_id TEXT NOT NULL REFERENCES projects(id) ON DELETE CASCADE, name TEXT NOT NULL, flow_data TEXT NOT NULL DEFAULT '{}', created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
     - Insert a default project: `INSERT OR IGNORE INTO projects (id, name) VALUES ('default', 'Default Project')` (Phase 2 uses single project)
   - `CreateScenario(projectID, name string) (*Scenario, error)`: generate UUID with `google/uuid`, insert with empty flow_data `{}`
   - `SaveScenario(id, flowData string) error`: UPDATE flow_data and updated_at WHERE id = ?
   - `LoadScenario(id string) (*Scenario, error)`: SELECT * WHERE id = ?
   - `ListScenarios(projectID string) ([]ScenarioListItem, error)`: SELECT id, project_id, name, created_at, updated_at WHERE project_id = ? ORDER BY updated_at DESC
   - `DeleteScenario(id string) error`: DELETE WHERE id = ?
   - `RenameScenario(id, newName string) error`: UPDATE name, updated_at WHERE id = ?
   - `Close() error`: close db connection

4. Create `internal/scenario/repository_test.go`:
   - Use `t.TempDir()` for temp database files
   - Test: CreateScenario returns valid scenario with UUID
   - Test: SaveScenario + LoadScenario roundtrip preserves flow_data JSON
   - Test: ListScenarios returns items in updated_at DESC order
   - Test: DeleteScenario removes the scenario
   - Test: RenameScenario updates name
   - Test: LoadScenario with non-existent ID returns sql.ErrNoRows

Note: Import `github.com/google/uuid` for UUID generation. Run `go get github.com/google/uuid`.

### Acceptance Criteria
- `cd /Users/kyh0703/Project/sipflow && go test ./internal/scenario/ -v` passes all tests
- Repository correctly creates/reads/updates/deletes scenarios
- Default project is auto-created on initialization
- Foreign key constraint is enforced (scenarios reference projects)
</task>

<task id="02-T2">

### Task 2: Create Wails binding + wire into app lifecycle

**Files to create:**
- `internal/binding/scenario_binding.go`

**Files to modify:**
- `app.go`
- `main.go`

**Action:**

1. Create `internal/binding/scenario_binding.go`:
   - Package `binding`
   - Import `context`, `sipflow/internal/scenario`, `github.com/wailsapp/wails/v2/pkg/runtime`
   - `ScenarioBinding` struct: ctx context.Context, repo *scenario.Repository
   - `NewScenarioBinding(repo *scenario.Repository) *ScenarioBinding`
   - `SetContext(ctx context.Context)`: save ctx
   - `CreateScenario(name string) (*scenario.Scenario, error)`: delegates to repo.CreateScenario("default", name) — uses default project for Phase 2
   - `SaveScenario(id, flowData string) error`: delegates to repo.SaveScenario
   - `LoadScenario(id string) (*scenario.Scenario, error)`: delegates to repo.LoadScenario
   - `ListScenarios() ([]scenario.ScenarioListItem, error)`: delegates to repo.ListScenarios("default")
   - `DeleteScenario(id string) error`: delegates to repo.DeleteScenario
   - `RenameScenario(id, newName string) error`: delegates to repo.RenameScenario
   - Each method logs errors with `runtime.LogError(s.ctx, ...)` and info with `runtime.LogInfo(s.ctx, ...)`

2. Modify `app.go`:
   - Add `scenarioBinding *binding.ScenarioBinding` field to App struct
   - Add `scenarioRepo *scenario.Repository` field to App struct
   - In `NewApp()`:
     - Determine DB path: `os.UserConfigDir()` + `/sipflow/scenarios.db`
     - Create directory with `os.MkdirAll`
     - Initialize repository: `scenario.NewRepository(dbPath)`
     - Initialize binding: `binding.NewScenarioBinding(repo)`
   - In `startup(ctx)`: call `a.scenarioBinding.SetContext(ctx)`
   - Add `shutdown()` method: call `a.scenarioRepo.Close()`

3. Modify `main.go`:
   - Add `OnShutdown: app.shutdown` to wails.Run options
   - Add `app.scenarioBinding` to Bind array
   - Increase default window size to Width: 1440, Height: 900 (scenario builder needs space)

### Acceptance Criteria
- `cd /Users/kyh0703/Project/sipflow && go build ./...` compiles without errors
- Wails binding is registered in main.go Bind array
- SQLite database is created at user config dir on startup
- Shutdown properly closes database connection
- `wails dev` starts without errors and generates TypeScript bindings in `frontend/wailsjs/go/binding/ScenarioBinding.{js,d.ts}`
</task>

## Verification

```bash
# Unit tests
cd /Users/kyh0703/Project/sipflow && go test ./internal/scenario/ -v

# Build check
cd /Users/kyh0703/Project/sipflow && go build ./...

# Verify wails bindings generate (run wails dev briefly)
# Check frontend/wailsjs/go/binding/ScenarioBinding.d.ts exists after wails dev
```

## Success Criteria

- SQLite repository passes all CRUD tests
- Wails binding exposes CreateScenario, SaveScenario, LoadScenario, ListScenarios, DeleteScenario, RenameScenario
- Database auto-creates at user config directory
- Default project is seeded on first run
- App compiles and starts without errors
