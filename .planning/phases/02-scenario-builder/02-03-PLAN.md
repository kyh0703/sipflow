---
phase: 02-scenario-builder
plan: 03
title: "Custom nodes + Node palette + 3-panel layout"
wave: 2
depends_on: [01]
files_modified:
  - frontend/src/features/scenario-builder/components/nodes/SipInstanceNode.tsx
  - frontend/src/features/scenario-builder/components/nodes/CommandNode.tsx
  - frontend/src/features/scenario-builder/components/nodes/EventNode.tsx
  - frontend/src/features/scenario-builder/components/nodes/index.ts
  - frontend/src/features/scenario-builder/components/NodePalette.tsx
  - frontend/src/features/scenario-builder/components/ScenarioBuilder.tsx
  - frontend/src/features/scenario-builder/components/Canvas.tsx
  - frontend/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "3 custom node types render with distinct visual styles per CONTEXT.md"
    - "Command nodes are blue rectangles, Event nodes are yellow rounded, SIP Instance nodes have start-point style"
    - "Each node has top input handle and bottom success(green)/failure(red) output handles"
    - "Nodes can be dragged from the left palette and dropped onto the canvas"
    - "3-panel layout is visible: left sidebar (~200px), center canvas, right placeholder (~280px)"
  artifacts:
    - path: "frontend/src/features/scenario-builder/components/nodes/SipInstanceNode.tsx"
      provides: "SIP Instance node component with DN/Endpoint mode display"
    - path: "frontend/src/features/scenario-builder/components/nodes/CommandNode.tsx"
      provides: "Command node component (MakeCall, Answer, Release)"
    - path: "frontend/src/features/scenario-builder/components/nodes/EventNode.tsx"
      provides: "Event node component (8 event types)"
    - path: "frontend/src/features/scenario-builder/components/NodePalette.tsx"
      provides: "Draggable node items grouped by category"
    - path: "frontend/src/features/scenario-builder/components/ScenarioBuilder.tsx"
      provides: "3-panel layout orchestrator"
  key_links:
    - from: "NodePalette.tsx"
      to: "hooks/useDnD.tsx"
      via: "onDragStart sets node type in DnD context"
    - from: "Canvas.tsx"
      to: "hooks/useDnD.tsx"
      via: "onDrop reads type from DnD context and creates node"
    - from: "Canvas.tsx"
      to: "nodes/index.ts"
      via: "nodeTypes registration object"
---

# Plan 02-03: Custom nodes + Node palette + 3-panel layout

## Objective

Implement the three custom node types (SipInstance, Command, Event) with their visual design per CONTEXT.md, the draggable node palette sidebar, and the 3-panel layout structure (left sidebar with palette, center canvas, right properties placeholder).

Purpose: This is the core visual experience of the scenario builder. Users see the three-panel layout and can drag nodes from the palette onto the canvas.

Output: A functional drag-and-drop scenario builder with custom-styled nodes and the complete layout structure.

## Tasks

<task id="03-T1">

### Task 1: Create 3 custom node components with visual styling

**Files to create:**
- `frontend/src/features/scenario-builder/components/nodes/SipInstanceNode.tsx`
- `frontend/src/features/scenario-builder/components/nodes/CommandNode.tsx`
- `frontend/src/features/scenario-builder/components/nodes/EventNode.tsx`
- `frontend/src/features/scenario-builder/components/nodes/index.ts`

**Action:**

1. Create `SipInstanceNode.tsx`:
   - Import Handle, Position, NodeProps from @xyflow/react
   - Import SipInstanceNode type from types/scenario
   - Visual style: Green/emerald gradient border, rounded-lg, distinct "start point" look — use a thicker top border or a small "play" icon indicator to show it's a start node
   - Display: Instance label, mode badge (DN/Endpoint), DN number if DN mode
   - Handles: NO target handle (it's a start node), 1 source handle at Bottom id="success" (green dot)
   - SIP Instance nodes don't have a failure branch — they're start points
   - Apply `border-l-4` with dynamic color from `data.color` for instance color coding
   - Min width: 160px

2. Create `CommandNode.tsx`:
   - Import Handle, Position, NodeProps from @xyflow/react
   - Import CommandNode type from types/scenario
   - Visual style: Blue background (bg-blue-50), blue border (border-blue-400), rectangular (rounded-md), border-2
   - Display: Command name (MakeCall/Answer/Release) as bold title, 1-2 key properties below (e.g., target URI for MakeCall)
   - Handles: 1 target handle at Top id="target", 2 source handles at Bottom — id="success" (left 30%, green bg) and id="failure" (left 70%, red bg)
   - Apply `border-l-4` with dynamic color from `data.sipInstanceId` -> look up instance color (use store or default gray if unassigned)
   - Icon: Use lucide-react icons per command type (Phone for MakeCall, PhoneIncoming for Answer, PhoneOff for Release)
   - Min width: 150px

3. Create `EventNode.tsx`:
   - Import Handle, Position, NodeProps from @xyflow/react
   - Import EventNode type from types/scenario
   - Visual style: Yellow/amber background (bg-amber-50), amber border (border-amber-400), rounded-xl (more rounded than command), border-2
   - Display: Event name as bold title, timeout value if TIMEOUT type
   - Handles: 1 target handle at Top id="target", 2 source handles at Bottom — id="success" (left 30%, green bg) and id="failure" (left 70%, red bg)
   - Apply `border-l-4` with dynamic color from sipInstanceId
   - Icon: Use lucide-react icons (Bell for INCOMING, PhoneMissed for DISCONNECTED, BellRing for RINGING, Clock for TIMEOUT, Pause for HELD, Play for RETRIEVED, ArrowRightLeft for TRANSFERRED, MessageSquare for NOTIFY)
   - Min width: 150px

4. Create `nodes/index.ts`:
   - Export `nodeTypes` object: `{ sipInstance: SipInstanceNode, command: CommandNode, event: EventNode }` — this must be defined OUTSIDE of components to prevent re-renders (React Flow requirement)
   - Re-export all node components

### Acceptance Criteria
- `cd /Users/kyh0703/Project/sipflow/frontend && npx tsc --noEmit` passes
- SipInstanceNode has NO target handle (start point), only success source
- CommandNode and EventNode have target + success + failure handles
- All handle IDs are unique strings ("target", "success", "failure")
- nodeTypes object is exported as a module-level constant (not inside a component)
- Command nodes use blue styling, Event nodes use amber/yellow styling
- Each node type displays an appropriate lucide-react icon
</task>

<task id="03-T2">

### Task 2: Create NodePalette + ScenarioBuilder 3-panel layout + wire Canvas

**Files to create:**
- `frontend/src/features/scenario-builder/components/NodePalette.tsx`
- `frontend/src/features/scenario-builder/components/ScenarioBuilder.tsx`

**Files to modify:**
- `frontend/src/features/scenario-builder/components/Canvas.tsx` (add nodeTypes, update drop handler)
- `frontend/src/App.tsx` (use ScenarioBuilder instead of raw Canvas)

**Action:**

1. Create `NodePalette.tsx`:
   - Three sections with headers: "SIP Instance", "Commands", "Events"
   - Each palette item is a draggable div with `draggable` attribute
   - `onDragStart` handler: set `event.dataTransfer.setData('application/reactflow', type)` AND call `useDnD().setType(type)`
   - `event.dataTransfer.effectAllowed = 'move'`
   - SIP Instance section: one item "SIP Instance" with green styling
   - Commands section: MakeCall, Answer, Release — each with blue styling and icon
   - Events section: INCOMING, DISCONNECTED, RINGING, TIMEOUT, HELD, RETRIEVED, TRANSFERRED, NOTIFY — each with amber styling and icon
   - Palette items should look like mini node previews (icon + name, matching node colors)
   - Use `cursor-grab` styling
   - Wrap each section in a collapsible group (use simple state toggle, no need for shadcn accordion)

2. Create `ScenarioBuilder.tsx`:
   - This is the main layout orchestrator
   - Wrap everything in `ReactFlowProvider` and `DnDProvider`
   - 3-panel flex layout: `<div className="flex h-screen w-screen">`
     - Left sidebar: `<div className="w-[200px] border-r border-border flex flex-col bg-background">` containing:
       - Upper area (placeholder for scenario tree — will be built in Plan 05): `<div className="flex-1 border-b p-3"><h3 className="text-sm font-semibold text-muted-foreground mb-2">Scenarios</h3><p className="text-xs text-muted-foreground">No scenarios yet</p></div>`
       - Lower area: `<div className="flex-1 overflow-y-auto p-3"><NodePalette /></div>`
     - Center: `<div className="flex-1"><Canvas /></div>`
     - Right sidebar: `<div className="w-[280px] border-l border-border bg-background overflow-y-auto p-4"><h3 className="text-sm font-semibold text-muted-foreground">Properties</h3><p className="text-xs text-muted-foreground mt-2">Select a node to edit properties</p></div>` (placeholder for Plan 04)

3. Update `Canvas.tsx`:
   - Import `nodeTypes` from `nodes/index`
   - Pass `nodeTypes` to ReactFlow
   - Update `onDrop` handler to create proper node data based on type:
     - For 'sipInstance': `{ label: 'SIP Instance', mode: 'DN', register: true, color: INSTANCE_COLORS[instanceCount % 6] }` — auto-assign next available color
     - For command types ('command-MakeCall', 'command-Answer', 'command-Release'): parse command name from type string, `{ label: commandName, command: commandName }`
     - For event types ('event-INCOMING', etc.): parse event name, `{ label: eventName, event: eventName }`
   - Generate node ID with `${type}-${Date.now()}`
   - Set node type to the category ('sipInstance', 'command', 'event')

4. Update `App.tsx`:
   - Replace Canvas with ScenarioBuilder component (remove ReactFlowProvider and DnDProvider from App since ScenarioBuilder handles them)

### Acceptance Criteria
- 3-panel layout renders: left (200px) / center (flex) / right (280px)
- NodePalette displays all 3 categories with all node types
- Dragging a palette item and dropping on canvas creates the correct node type
- Created nodes render with correct visual styling (blue commands, amber events, green SIP instance)
- Handles render correctly: SipInstance has only success source, Command/Event have target + success + failure
- `npx tsc --noEmit` passes
</task>

## Verification

```bash
cd /Users/kyh0703/Project/sipflow/frontend && npx tsc --noEmit
```

Visual verification with `wails dev`:
1. 3-panel layout is visible with correct widths
2. Left palette shows SIP Instance, Commands (3), Events (8) sections
3. Drag MakeCall from palette -> drop on canvas -> blue command node appears
4. Drag INCOMING from palette -> drop on canvas -> amber event node appears
5. Drag SIP Instance -> drop -> green start-point node appears
6. Nodes show correct handles (top input, bottom success/failure)

## Success Criteria

- 3 custom node types render with distinct visual styles matching CONTEXT.md
- Node palette enables drag-and-drop to canvas
- 3-panel layout structure established
- All node categories (SIP Instance, Command, Event) functional
