---
phase: 02-scenario-builder
plan: 01
title: "TypeScript types + Zustand store + Canvas shell"
wave: 1
depends_on: []
files_modified:
  - frontend/src/features/scenario-builder/types/scenario.ts
  - frontend/src/features/scenario-builder/store/scenarioStore.ts
  - frontend/src/features/scenario-builder/components/Canvas.tsx
  - frontend/src/features/scenario-builder/edges/BranchEdge.tsx
  - frontend/src/features/scenario-builder/hooks/useDnD.tsx
  - frontend/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "All node types (SipInstance, Command, Event) have TypeScript type definitions"
    - "Zustand store manages nodes/edges with add/remove/update operations"
    - "Canvas renders with dot grid background and accepts node/edge changes"
    - "Branch edges display green (success) and red (failure) colors"
  artifacts:
    - path: "frontend/src/features/scenario-builder/types/scenario.ts"
      provides: "TypeScript types for SipInstanceNode, CommandNode, EventNode, ScenarioNode union"
      exports: ["SipInstanceNodeData", "CommandNodeData", "EventNodeData", "SipInstanceNode", "CommandNode", "EventNode", "ScenarioNode", "BranchEdgeData"]
    - path: "frontend/src/features/scenario-builder/store/scenarioStore.ts"
      provides: "Zustand store with nodes/edges state and CRUD operations"
      exports: ["useScenarioStore"]
    - path: "frontend/src/features/scenario-builder/components/Canvas.tsx"
      provides: "ReactFlow canvas wrapper with dot background"
    - path: "frontend/src/features/scenario-builder/edges/BranchEdge.tsx"
      provides: "Custom edge with success/failure color coding"
    - path: "frontend/src/features/scenario-builder/hooks/useDnD.tsx"
      provides: "DnD context provider for palette-to-canvas drag"
  key_links:
    - from: "Canvas.tsx"
      to: "scenarioStore.ts"
      via: "useScenarioStore hook for nodes/edges/onNodesChange/onEdgesChange/onConnect"
    - from: "Canvas.tsx"
      to: "BranchEdge.tsx"
      via: "edgeTypes registration"
---

# Plan 02-01: TypeScript types + Zustand store + Canvas shell

## Objective

Build the data layer and canvas foundation for the scenario builder. This plan establishes all TypeScript types, the Zustand store for flow state management, the DnD context, the branch edge component, and a working ReactFlow canvas with dot grid background.

Purpose: Everything else in Phase 2 depends on these types and the store. The canvas shell proves ReactFlow renders correctly in the Wails WebView.

Output: A working canvas page (replacing the current ping/pong App.tsx) with empty ReactFlow + dot grid, ready for custom nodes and palette.

## Tasks

<task id="01-T1">

### Task 1: Create TypeScript types and DnD context

Create the feature directory structure and all TypeScript type definitions for the scenario builder domain model. Also create the DnD context hook that will be used for palette-to-canvas drag and drop.

**Files to create:**
- `frontend/src/features/scenario-builder/types/scenario.ts`
- `frontend/src/features/scenario-builder/hooks/useDnD.tsx`

**Action:**

1. Create `frontend/src/features/scenario-builder/types/scenario.ts` with these types:

   - `SipInstanceNodeData`: label, mode ('DN' | 'Endpoint'), dn?, register (boolean), serverId?, color (string for instance color)
   - `CommandNodeData`: label, command ('MakeCall' | 'Answer' | 'Release'), sipInstanceId?, targetUri? (for MakeCall), timeout? (number, ms)
   - `EventNodeData`: label, event ('INCOMING' | 'DISCONNECTED' | 'RINGING' | 'TIMEOUT' | 'HELD' | 'RETRIEVED' | 'TRANSFERRED' | 'NOTIFY'), sipInstanceId?, timeout? (for TIMEOUT event)
   - Node types using `Node<TData, TType>` from @xyflow/react: `SipInstanceNode = Node<SipInstanceNodeData, 'sipInstance'>`, `CommandNode = Node<CommandNodeData, 'command'>`, `EventNode = Node<EventNodeData, 'event'>`
   - `ScenarioNode = SipInstanceNode | CommandNode | EventNode` union type
   - `BranchEdgeData`: branchType ('success' | 'failure')
   - `NODE_CATEGORIES` constant object: `{ SIP_INSTANCE: 'sipInstance', COMMAND: 'command', EVENT: 'event' } as const`
   - `COMMAND_TYPES` array: `['MakeCall', 'Answer', 'Release'] as const`
   - `EVENT_TYPES` array: `['INCOMING', 'DISCONNECTED', 'RINGING', 'TIMEOUT', 'HELD', 'RETRIEVED', 'TRANSFERRED', 'NOTIFY'] as const`
   - `INSTANCE_COLORS` array of 6 preset hex colors for instance color assignment (blue, teal, orange, purple, pink, cyan)

2. Create `frontend/src/features/scenario-builder/hooks/useDnD.tsx`:
   - DnDContext with `createContext` holding: `type` (string | null), `setType` (setter function)
   - `DnDProvider` component wrapping children with context state
   - `useDnD` hook exporting context value
   - Pattern follows React Flow DnD example: palette sets `type` on dragStart, canvas reads `type` on drop

### Acceptance Criteria
- TypeScript compiles with no errors: `cd frontend && npx tsc --noEmit`
- All 3 node data types and 3 node types are exported
- ScenarioNode union type exists
- DnDProvider and useDnD are exported
- INSTANCE_COLORS has exactly 6 colors
- COMMAND_TYPES matches locked decisions: MakeCall, Answer, Release
- EVENT_TYPES matches locked decisions: all 8 event types
</task>

<task id="01-T2">

### Task 2: Create Zustand store, Branch edge, and Canvas component

Build the central state management store, the custom branch edge component, and the ReactFlow canvas wrapper. Wire everything together and replace the current App.tsx with the scenario builder shell.

**Files to create:**
- `frontend/src/features/scenario-builder/store/scenarioStore.ts`
- `frontend/src/features/scenario-builder/edges/BranchEdge.tsx`
- `frontend/src/features/scenario-builder/components/Canvas.tsx`

**File to modify:**
- `frontend/src/App.tsx`

**Action:**

1. Create `frontend/src/features/scenario-builder/store/scenarioStore.ts`:
   - Import `create` from zustand, import `applyNodeChanges`, `applyEdgeChanges`, `addEdge`, `OnNodesChange`, `OnEdgesChange`, `OnConnect`, `Node`, `Edge` from @xyflow/react
   - Import `ScenarioNode` from types
   - Store interface `ScenarioState`:
     - `nodes: Node[]`, `edges: Edge[]`
     - `selectedNodeId: string | null`
     - `onNodesChange: OnNodesChange`
     - `onEdgesChange: OnEdgesChange`
     - `onConnect: OnConnect`
     - `addNode: (node: Node) => void`
     - `removeNode: (nodeId: string) => void`
     - `updateNodeData: (nodeId: string, data: Partial<any>) => void`
     - `setSelectedNode: (nodeId: string | null) => void`
     - `setNodes: (nodes: Node[]) => void`
     - `setEdges: (edges: Edge[]) => void`
     - `clearCanvas: () => void`
   - Implement all actions following immutable update pattern (new objects, never mutate)
   - `onConnect` should create edges with `type: 'branch'` and set `data.branchType` based on `connection.sourceHandle` ('success' or 'failure')
   - `removeNode` should also remove connected edges

2. Create `frontend/src/features/scenario-builder/edges/BranchEdge.tsx`:
   - Use `BaseEdge`, `getSmoothStepPath`, `EdgeProps` from @xyflow/react
   - Accept `BranchEdgeData` type for data prop
   - Color: green (#22c55e) for success, red (#ef4444) for failure, gray (#94a3b8) for default
   - strokeWidth: 2
   - Export `edgeTypes = { branch: BranchEdge }` constant

3. Create `frontend/src/features/scenario-builder/components/Canvas.tsx`:
   - Import ReactFlow, Background, BackgroundVariant, Controls, MiniMap from @xyflow/react
   - Import `@xyflow/react/dist/style.css` for default styles
   - Import `useScenarioStore` with shallow selector
   - Import `edgeTypes` from BranchEdge
   - Import `useDnD` from hooks, `useReactFlow` (screenToFlowPosition)
   - Implement `onDrop` handler: read `type` from DnD context, create new node at drop position using `screenToFlowPosition`, add to store
   - Implement `onDragOver` handler: `event.preventDefault()`, `event.dataTransfer.dropEffect = 'move'`
   - Render ReactFlow with: nodes, edges, onNodesChange, onEdgesChange, onConnect from store, nodeTypes (empty object for now, will be filled in Plan 03), edgeTypes, Background (Dots variant, gap 20, size 1, color #d1d5db), Controls, MiniMap
   - Add `onNodeClick` handler to set `selectedNodeId` in store
   - Add `onPaneClick` handler to clear `selectedNodeId`
   - Set `fitView` prop

4. Modify `frontend/src/App.tsx`:
   - Replace all current content with the scenario builder shell
   - Wrap with `ReactFlowProvider` from @xyflow/react
   - Wrap with `DnDProvider`
   - Render a simple flex layout: `<div className="flex h-screen w-screen">` containing only `<Canvas />` for now (filling full width/height)
   - Remove all ping/pong code (Phase 1 verification is complete, no longer needed)

### Acceptance Criteria
- `cd frontend && npx tsc --noEmit` passes
- App renders ReactFlow canvas with dot grid background
- Canvas shows Controls (zoom in/out) and MiniMap
- Store exports `useScenarioStore` hook with all specified actions
- BranchEdge renders with correct colors for success/failure
- No console errors when running `wails dev`
</task>

## Verification

```bash
cd /Users/kyh0703/Project/sipflow/frontend && npx tsc --noEmit
```

Verify visually that `wails dev` shows a full-screen ReactFlow canvas with dot grid background, zoom controls, and minimap.

## Success Criteria

- TypeScript types define all 3 node categories with correct properties per CONTEXT.md
- Zustand store manages nodes/edges with immutable updates
- ReactFlow canvas renders with dot grid, controls, minimap
- DnD context is ready for palette integration
- Branch edge component shows green/red coloring
- App.tsx replaced with scenario builder shell
