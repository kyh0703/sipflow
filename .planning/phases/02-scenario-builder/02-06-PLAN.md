---
phase: 02-scenario-builder
plan: 06
title: "Scenario validation + error display + final verification"
wave: 3
depends_on: [03, 04]
files_modified:
  - frontend/src/features/scenario-builder/lib/validation.ts
  - frontend/src/features/scenario-builder/hooks/useValidation.ts
  - frontend/src/features/scenario-builder/components/Canvas.tsx
  - frontend/src/features/scenario-builder/store/scenarioStore.ts
  - frontend/src/features/scenario-builder/components/nodes/CommandNode.tsx
  - frontend/src/features/scenario-builder/components/nodes/EventNode.tsx
  - frontend/src/features/scenario-builder/components/nodes/SipInstanceNode.tsx
autonomous: false

must_haves:
  truths:
    - "Cycle detection prevents creating circular connections in real-time"
    - "Save-time validation checks all 4 rules: cycles, isolated nodes, required fields, instance assignments"
    - "Validation errors highlight problem nodes with red border"
    - "Validation errors show toast messages describing the issues"
    - "Users see clear visual feedback when a connection would create a cycle"
  artifacts:
    - path: "frontend/src/features/scenario-builder/lib/validation.ts"
      provides: "Pure validation functions: detectCycles, detectIsolatedNodes, validateInstanceAssignments, validateRequiredFields, validateScenario"
      exports: ["ValidationError", "validateScenario", "wouldCreateCycle"]
    - path: "frontend/src/features/scenario-builder/hooks/useValidation.ts"
      provides: "Hook connecting validation to store and UI"
      exports: ["useValidation"]
  key_links:
    - from: "Canvas.tsx"
      to: "lib/validation.ts"
      via: "isValidConnection calls wouldCreateCycle for real-time check"
    - from: "hooks/useValidation.ts"
      to: "lib/validation.ts"
      via: "calls validateScenario for full save-time validation"
    - from: "hooks/useValidation.ts"
      to: "scenarioStore.ts"
      via: "reads nodes/edges, sets validationErrors"
---

# Plan 02-06: Scenario validation + error display + final verification

## Objective

Implement the complete validation system per CONTEXT.md: real-time cycle detection during edge creation, and full scenario validation on save with 4 rules (cycles, isolated nodes, required fields, instance assignments). Display errors via node highlighting and toast messages.

Purpose: Validation ensures users create valid DAG scenarios. Without it, the execution engine (Phase 3) would receive broken graphs.

Output: Real-time cycle prevention, save-time full validation, visual error feedback.

## Tasks

<task id="06-T1">

### Task 1: Create validation library and useValidation hook

**Files to create:**
- `frontend/src/features/scenario-builder/lib/validation.ts`
- `frontend/src/features/scenario-builder/hooks/useValidation.ts`

**Files to modify:**
- `frontend/src/features/scenario-builder/store/scenarioStore.ts`

**Action:**

1. Install sonner for toast notifications:
   ```bash
   cd /Users/kyh0703/Project/sipflow/frontend && npx shadcn@latest add sonner
   ```

2. Create `lib/validation.ts`:
   - Import `Node`, `Edge`, `getOutgoers` from @xyflow/react
   - Define `ValidationError` interface: `{ type: 'cycle' | 'isolated' | 'missing-instance' | 'missing-required-field', nodeId?: string, message: string }`

   - `wouldCreateCycle(nodes: Node[], edges: Edge[], newConnection: { source: string, target: string }): boolean`:
     - Prevent self-loops: if source === target, return true
     - Temporarily add the new connection to edges
     - Use DFS from target node following outgoing edges
     - If we reach the source node, a cycle exists
     - Return true if cycle detected, false otherwise
     - Uses `getOutgoers()` from @xyflow/react for traversal

   - `detectCycles(nodes: Node[], edges: Edge[]): ValidationError[]`:
     - Full cycle detection using DFS with visited + recursion stack
     - Returns array of cycle errors with involved node IDs

   - `detectIsolatedNodes(nodes: Node[], edges: Edge[]): ValidationError[]`:
     - Find all SIP Instance nodes (type === 'sipInstance') as start points
     - BFS/DFS from all start points to find reachable nodes
     - Any non-start node that is not reachable is isolated
     - Return errors for isolated nodes

   - `validateInstanceAssignments(nodes: Node[]): ValidationError[]`:
     - For every node that is NOT a sipInstance node:
       - Check if `data.sipInstanceId` is set and non-empty
       - If missing, create error with nodeId and message
     - Return errors

   - `validateRequiredFields(nodes: Node[]): ValidationError[]`:
     - For MakeCall command nodes: require `data.targetUri` to be non-empty
     - For TIMEOUT event nodes: require `data.timeout` to be a positive number
     - For SIP Instance nodes in DN mode: require `data.dn` to be non-empty
     - Return errors for missing required fields

   - `validateScenario(nodes: Node[], edges: Edge[]): ValidationError[]`:
     - Run all 4 validators
     - Return combined array of all errors
     - If nodes.length === 0, return single error "Scenario is empty"

3. Create `hooks/useValidation.ts`:
   - Import `useScenarioStore`
   - Import `validateScenario`, `ValidationError` from lib/validation
   - Import `toast` from sonner
   - `useValidation()` hook returns:
     - `validate(): ValidationError[]` — runs full validation on current store state
     - `validateAndNotify(): boolean` — runs validate(), shows toast for each error, returns true if valid (no errors)
     - `errorNodeIds: Set<string>` — derived from last validation run, for node highlighting

4. Update `scenarioStore.ts`:
   - Add `validationErrors: ValidationError[]` to state
   - Add `setValidationErrors(errors: ValidationError[]): void`
   - Add `clearValidationErrors(): void`

### Acceptance Criteria
- `wouldCreateCycle` correctly detects cycles in graph
- `detectIsolatedNodes` finds nodes not reachable from any SIP Instance
- `validateInstanceAssignments` catches nodes without instance assignment
- `validateRequiredFields` catches MakeCall without targetUri, TIMEOUT without timeout, DN instance without dn
- `validateScenario` combines all validators
- useValidation hook triggers toasts for errors
- `npx tsc --noEmit` passes
</task>

<task id="06-T2">

### Task 2: Wire validation into Canvas + node error highlighting

**Files to modify:**
- `frontend/src/features/scenario-builder/components/Canvas.tsx`
- `frontend/src/features/scenario-builder/components/nodes/CommandNode.tsx`
- `frontend/src/features/scenario-builder/components/nodes/EventNode.tsx`
- `frontend/src/features/scenario-builder/components/nodes/SipInstanceNode.tsx`
- `frontend/src/features/scenario-builder/components/ScenarioBuilder.tsx` (add Toaster)

**Action:**

1. Update `Canvas.tsx`:
   - Import `wouldCreateCycle` from lib/validation
   - Update `isValidConnection` callback to use `wouldCreateCycle(nodes, edges, connection)` — return false if cycle would be created
   - Integrate save-time validation: in the Ctrl+S handler (from Plan 05), before saving:
     - Call `useValidation().validateAndNotify()`
     - If validation fails (returns false), still save but show warnings as toasts
     - Set `validationErrors` in store so nodes can highlight

2. Update all 3 node components to show error state:
   - Read `validationErrors` from `useScenarioStore`
   - Check if current node's ID is in the error list
   - If error: add `ring-2 ring-red-500` class to the outer div + subtle red glow `shadow-red-200`
   - This creates a red outline around problem nodes per CONTEXT.md requirement

3. Update `ScenarioBuilder.tsx`:
   - Import `Toaster` from sonner
   - Add `<Toaster position="bottom-right" richColors />` at the top level
   - This enables toast notifications from the validation hook

### Acceptance Criteria
- Creating an edge that would form a cycle is blocked (real-time)
- Pressing Ctrl+S runs validation and shows toast for each error
- Problem nodes get red ring highlight
- Toasts appear in bottom-right corner with descriptive error messages
- After fixing issues and re-saving, errors clear and highlights disappear
- `npx tsc --noEmit` passes
</task>

<task id="06-T3" type="checkpoint:human-verify">

### Task 3: Full scenario builder verification

<what-built>
Complete scenario builder with all Phase 2 features:
- 3-panel layout (palette / canvas / properties)
- 3 node types (SIP Instance, Command, Event) with visual styling
- Drag-and-drop from palette to canvas
- Edge connections with success/failure coloring
- Properties panel with per-node forms
- Scenario CRUD (create/save/load/delete/rename) via SQLite
- Real-time cycle detection + save-time validation
- Error highlighting and toast notifications
</what-built>

<how-to-verify>
Run `wails dev` and verify:

1. **Layout**: 3 panels visible — left (scenarios + palette), center (canvas), right (properties)
2. **Node creation**: Drag each of the 12 node types from palette to canvas:
   - SIP Instance (1)
   - Commands: MakeCall, Answer, Release (3)
   - Events: INCOMING, DISCONNECTED, RINGING, TIMEOUT, HELD, RETRIEVED, TRANSFERRED, NOTIFY (8)
3. **Node visuals**: SIP Instance is green/emerald, Commands are blue, Events are amber/yellow
4. **Handles**: SIP Instance has no top handle (start node), Commands/Events have top + bottom success/failure
5. **Connections**: Connect MakeCall success -> Answer, MakeCall failure -> DISCONNECTED — verify green/red edge colors
6. **Properties**: Click each node type and verify the right panel shows correct form fields
7. **Instance assignment**: Create SIP Instance, then assign a Command to it via properties dropdown
8. **Cycle prevention**: Try to create a circular connection (A -> B -> A) — should be blocked
9. **Save/Load**: Create scenario "Test1", add nodes, Ctrl+S, create "Test2", click "Test1" -> nodes restored
10. **Validation**: Add MakeCall without target URI, Ctrl+S -> toast warning and red highlight
11. **Persistence**: Close app, reopen, scenarios still listed and loadable
</how-to-verify>

<resume-signal>Type "approved" if everything works, or describe any issues found.</resume-signal>
</task>

## Verification

```bash
cd /Users/kyh0703/Project/sipflow/frontend && npx tsc --noEmit
cd /Users/kyh0703/Project/sipflow && go build ./...
```

## Success Criteria

- Real-time cycle detection blocks invalid connections
- Save-time validation checks all 4 rules per CONTEXT.md
- Error nodes highlighted with red ring
- Toast notifications for validation errors
- Complete Phase 2 feature set verified by human
