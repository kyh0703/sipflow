---
phase: 02-scenario-builder
plan: 04
title: "Edge connection system + Properties panel"
wave: 2
depends_on: [01]
files_modified:
  - frontend/src/features/scenario-builder/components/PropertiesPanel.tsx
  - frontend/src/features/scenario-builder/components/properties/SipInstanceProperties.tsx
  - frontend/src/features/scenario-builder/components/properties/CommandProperties.tsx
  - frontend/src/features/scenario-builder/components/properties/EventProperties.tsx
  - frontend/src/features/scenario-builder/components/ScenarioBuilder.tsx
  - frontend/src/features/scenario-builder/store/scenarioStore.ts
autonomous: true

must_haves:
  truths:
    - "Nodes can be connected by dragging from source handle to target handle"
    - "Edges show green for success branch and red for failure branch"
    - "Selecting a node opens its properties in the right panel"
    - "Properties panel shows node-specific forms based on node type"
    - "Property changes update node data in the store"
    - "Nodes have instance assignment dropdown in properties"
  artifacts:
    - path: "frontend/src/features/scenario-builder/components/PropertiesPanel.tsx"
      provides: "Router component that renders correct properties form based on selected node type"
    - path: "frontend/src/features/scenario-builder/components/properties/SipInstanceProperties.tsx"
      provides: "Properties form for SIP Instance node (mode, DN, register, server)"
    - path: "frontend/src/features/scenario-builder/components/properties/CommandProperties.tsx"
      provides: "Properties form for Command nodes (target URI, timeout, instance assignment)"
    - path: "frontend/src/features/scenario-builder/components/properties/EventProperties.tsx"
      provides: "Properties form for Event nodes (timeout for TIMEOUT, instance assignment)"
  key_links:
    - from: "PropertiesPanel.tsx"
      to: "scenarioStore.ts"
      via: "reads selectedNodeId and finds node from nodes array"
    - from: "properties/*Properties.tsx"
      to: "scenarioStore.ts"
      via: "calls updateNodeData to persist form changes"
    - from: "ScenarioBuilder.tsx"
      to: "PropertiesPanel.tsx"
      via: "renders in right sidebar"
---

# Plan 02-04: Edge connection system + Properties panel

## Objective

Complete the node interaction layer: edge connections between nodes with success/failure branch coloring, and the right-sidebar properties panel that shows node-specific editing forms when a node is selected.

Purpose: Without properties editing, nodes are just visual boxes. Without edge connections, there's no flow. This plan makes the scenario builder functional for authoring flows.

Output: Users can connect nodes with colored edges and edit all node properties via the right panel.

## Tasks

<task id="04-T1">

### Task 1: Properties panel with node-specific forms

**Files to create:**
- `frontend/src/features/scenario-builder/components/PropertiesPanel.tsx`
- `frontend/src/features/scenario-builder/components/properties/SipInstanceProperties.tsx`
- `frontend/src/features/scenario-builder/components/properties/CommandProperties.tsx`
- `frontend/src/features/scenario-builder/components/properties/EventProperties.tsx`

**Files to modify:**
- `frontend/src/features/scenario-builder/components/ScenarioBuilder.tsx` (replace right sidebar placeholder with PropertiesPanel)

**Action:**

1. Install required shadcn/ui components for forms (run from frontend/):
   ```bash
   cd /Users/kyh0703/Project/sipflow/frontend
   npx shadcn@latest add input label select switch separator badge
   ```

2. Create `PropertiesPanel.tsx`:
   - Read `selectedNodeId` and `nodes` from `useScenarioStore`
   - Find the selected node from nodes array
   - If no node selected: render empty state "Select a node to edit properties" with an icon
   - If node selected: render header with node type badge (colored per type) + node ID
   - Switch on `node.type`: render `SipInstanceProperties`, `CommandProperties`, or `EventProperties`
   - Pass the node and `updateNodeData` function as props

3. Create `SipInstanceProperties.tsx`:
   - Props: `node: SipInstanceNode`, `onUpdate: (data: Partial<SipInstanceNodeData>) => void`
   - Form fields:
     - **Label**: text input (editable instance name)
     - **Mode**: select dropdown DN / Endpoint
     - **DN Number**: text input (visible only when mode = 'DN')
     - **Register**: switch toggle (default ON for DN, OFF for Endpoint)
     - **SIP Server**: text input for server URI (visible only when mode = 'Endpoint')
     - **Color**: row of 6 color circles (INSTANCE_COLORS), click to select
   - Each field change calls `onUpdate({ fieldName: value })`
   - All interactive elements inside the panel use `nodrag` class (though they're outside the node, this is good practice)
   - Mode change should auto-toggle Register (DN -> ON, Endpoint -> OFF)

4. Create `CommandProperties.tsx`:
   - Props: `node: CommandNode`, `onUpdate: (data: Partial<CommandNodeData>) => void`
   - Common fields for all commands:
     - **Command Type**: read-only badge showing MakeCall/Answer/Release
     - **SIP Instance**: select dropdown populated from all SIP Instance nodes on canvas (read from store)
     - **Label**: text input
   - Conditional fields per command:
     - **MakeCall**: Target URI (text input, placeholder "sip:user@domain"), Timeout (number input, ms, default 30000)
     - **Answer**: Response Code (number, default 200, read-only for now)
     - **Release**: Cause (text input, placeholder "Normal clearing")

5. Create `EventProperties.tsx`:
   - Props: `node: EventNode`, `onUpdate: (data: Partial<EventNodeData>) => void`
   - Fields:
     - **Event Type**: read-only badge showing event name
     - **SIP Instance**: select dropdown (same as CommandProperties)
     - **Label**: text input
     - **Timeout**: number input in ms (visible only for TIMEOUT event type, default 5000)

6. Update `ScenarioBuilder.tsx`:
   - Replace right sidebar placeholder content with `<PropertiesPanel />`
   - Keep the 280px width and border

### Acceptance Criteria
- Clicking a node on canvas shows its properties in the right panel
- Clicking empty canvas (pane) clears the properties panel
- SipInstanceProperties: mode toggle switches between DN/Endpoint fields
- CommandProperties: SIP Instance dropdown shows all SIP Instance nodes from canvas
- EventProperties: Timeout field only visible for TIMEOUT event
- All property changes persist in the store (verify by checking node data after edit)
- `npx tsc --noEmit` passes
</task>

<task id="04-T2">

### Task 2: Edge connection validation and instance color propagation

**Files to modify:**
- `frontend/src/features/scenario-builder/store/scenarioStore.ts` (add edge validation, instance color helpers)
- `frontend/src/features/scenario-builder/components/Canvas.tsx` (add isValidConnection, connection line styling)

**Action:**

1. Update `scenarioStore.ts`:
   - Add `getInstanceNodes` selector: returns all nodes where `type === 'sipInstance'`
   - Add `getInstanceColor(instanceId: string) => string`: look up the SIP Instance node by ID and return its `data.color`, or '#94a3b8' (gray) if not found
   - Update `onConnect` handler: when a new connection is made from sourceHandle 'success' or 'failure', set the edge `data.branchType` accordingly. If sourceHandle is 'success', branchType = 'success'. If 'failure', branchType = 'failure'.

2. Update `Canvas.tsx`:
   - Add `isValidConnection` callback:
     - Prevent self-connections (source === target)
     - Prevent connecting TO a SipInstance node (they are start nodes, no target handle â€” this is a safety check)
     - Prevent duplicate connections from the same sourceHandle (one edge per handle)
   - Add `connectionLineStyle` prop: `{ stroke: '#94a3b8', strokeWidth: 2 }`
   - Add `defaultEdgeOptions`: `{ type: 'branch' }`
   - SipInstance nodes already don't have target handles (from Plan 03), but validation adds an extra safety layer

### Acceptance Criteria
- Dragging from a source handle to a target handle creates an edge
- Edges from "success" handle are green, from "failure" handle are red
- Self-connections are blocked
- Only one edge per source handle is allowed
- Connection to SipInstance target is blocked
- Instance color lookup returns correct color or gray default
- `npx tsc --noEmit` passes
</task>

## Verification

```bash
cd /Users/kyh0703/Project/sipflow/frontend && npx tsc --noEmit
```

Visual verification with `wails dev`:
1. Drop SIP Instance node, click it -> right panel shows instance properties with mode/DN/register
2. Drop MakeCall node, click it -> right panel shows command properties with target URI, instance dropdown
3. Drop INCOMING event, click it -> right panel shows event properties with instance dropdown
4. Change properties -> node visuals update (label changes visible on node)
5. Connect success handle of MakeCall to INCOMING target -> green edge
6. Connect failure handle of MakeCall to DISCONNECTED target -> red edge
7. Attempt self-connection -> blocked

## Success Criteria

- Properties panel renders per-node forms for all 3 node types
- Property edits persist in Zustand store
- Edge connections work with branch coloring
- Connection validation prevents invalid edges
- Instance assignment dropdown shows available SIP instances
