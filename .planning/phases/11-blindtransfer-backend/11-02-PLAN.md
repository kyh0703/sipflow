---
phase: 11-blindtransfer-backend
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - internal/engine/executor.go
  - internal/engine/executor_test.go
autonomous: true

must_haves:
  truths:
    - "OnRefer 콜백이 referDialog.Invite() + Ack()를 완료한 후 SessionStore를 교체한다"
    - "OnRefer 콜백이 Refer-To URI를 추출하여 ActionLog에 기록한다 (ROADMAP 성공기준 4번)"
    - "OnRefer 콜백이 StoreDialog() 완료 후에만 emitSIPEvent(TRANSFERRED)를 발행한다"
    - "executeBlindTransfer의 에러 경로(dialog 미존재, 빈 targetUser/targetHost)가 테스트된다"
    - "TRANSFERRED 이벤트의 executeEvent 스위치 라우팅과 타임아웃 경로가 테스트된다"
  artifacts:
    - path: "internal/engine/executor.go"
      provides: "OnRefer 콜백 완전 구현 (Refer-To URI + Invite/Ack + SessionStore 교체)"
      contains: "referDialog.Invite"
    - path: "internal/engine/executor_test.go"
      provides: "BlindTransfer 에러 경로 테스트, TRANSFERRED 이벤트 라우팅 테스트, OnRefer SessionStore 교체 테스트"
      contains: "TestExecuteBlindTransfer"
  key_links:
    - from: "internal/engine/executor.go OnRefer"
      to: "diago DialogClientSession"
      via: "referDialog.Invite(inviteCtx, diago.InviteClientOptions{})"
      pattern: "referDialog\\.Invite"
    - from: "internal/engine/executor.go OnRefer"
      to: "internal/engine/executor.go SessionStore"
      via: "ex.sessions.StoreDialog(instanceID, referDialog)"
      pattern: "StoreDialog.*referDialog"
    - from: "internal/engine/executor.go OnRefer"
      to: "internal/engine/engine.go emitSIPEvent"
      via: "ex.engine.emitSIPEvent(instanceID, TRANSFERRED)"
      pattern: "emitSIPEvent.*TRANSFERRED"
    - from: "internal/engine/executor_test.go"
      to: "internal/engine/executor.go"
      via: "executeBlindTransfer/executeCommand/executeEvent 에러 경로 검증"
      pattern: "TestExecuteBlindTransfer"
---

<objective>
OnRefer 콜백을 Phase 10 스텁에서 완전한 구현으로 확장하고, Phase 11 전체 기능에 대한 에러 경로 + 이벤트 라우팅 테스트를 작성한다.

Purpose: XFER-02 요구사항의 TransferEvent 노드가 상대방 REFER를 실제로 처리하도록 한다. OnRefer 콜백에서 새 dialog를 활성화(Invite+Ack)하고 SessionStore를 교체한 후 TRANSFERRED 이벤트를 발행하여, TransferEvent 노드가 이를 수신하고 후속 노드로 진행할 수 있다.
Output: OnRefer 콜백 완전 구현, BlindTransfer/TRANSFERRED 에러 경로 테스트, 전체 go test 통과
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-blindtransfer-backend/11-RESEARCH.md
@.planning/phases/11-blindtransfer-backend/CONTEXT.md
@.planning/phases/11-blindtransfer-backend/11-01-SUMMARY.md
@internal/engine/executor.go
@internal/engine/executor_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: OnRefer 콜백 확장 — Refer-To URI 추출 + Invite/Ack + SessionStore 교체</name>
  <files>
    internal/engine/executor.go
  </files>
  <action>
**executor.go — executeAnswer()의 OnRefer 콜백 확장:**

현재 Phase 10 스텁 (executor.go:322-328):
```go
OnRefer: func(referDialog *diago.DialogClientSession) error {
    ex.engine.emitSIPEvent(instanceID, "TRANSFERRED")
    ex.engine.emitActionLog(node.ID, instanceID, "REFER received (transfer)", "info",
        WithSIPMessage("received", "REFER", 0, "", "", ""))
    return nil
},
```

이를 완전한 구현으로 교체. 11-RESEARCH.md 패턴 2 (예시 2: OnRefer 콜백 완전한 구현)을 따른다.

**새 OnRefer 구현:**
```go
OnRefer: func(referDialog *diago.DialogClientSession) error {
    // 1. Refer-To URI 추출 (ROADMAP 성공기준 4번)
    referToURIStr := "<unknown>"
    if referDialog.InviteRequest != nil {
        referToURIStr = referDialog.InviteRequest.RequestURI().String()
    }

    // 2. ActionLog에 Refer-To URI 기록 (수신 로그)
    ex.engine.emitActionLog(node.ID, instanceID,
        fmt.Sprintf("REFER received: Refer-To=%s", referToURIStr), "info",
        WithSIPMessage("received", "REFER", 202, "", "", referToURIStr))

    // 3. 새 dialog (referDialog)로 INVITE 전송 + ACK
    //    referDialog는 dialogReferInvite()가 생성한 초기 상태 — INVITE 미전송
    //    Invite() + Ack() 완료해야 새 통화 세션이 성립
    inviteCtx := referDialog.Context()
    if err := referDialog.Invite(inviteCtx, diago.InviteClientOptions{}); err != nil {
        ex.engine.emitActionLog(node.ID, instanceID,
            fmt.Sprintf("TransferEvent: Invite to Refer-To failed: %v", err), "error")
        return fmt.Errorf("TransferEvent: referDialog Invite failed: %w", err)
    }
    if err := referDialog.Ack(inviteCtx); err != nil {
        ex.engine.emitActionLog(node.ID, instanceID,
            fmt.Sprintf("TransferEvent: Ack failed: %v", err), "error")
        return fmt.Errorf("TransferEvent: referDialog Ack failed: %w", err)
    }

    // 4. SessionStore 교체 (기존 dialog → referDialog)
    //    반드시 Invite+Ack 완료 후, emitSIPEvent 전에 실행
    ex.sessions.StoreDialog(instanceID, referDialog)

    // 5. TRANSFERRED 이벤트 발행 (executeWaitSIPEvent 대기 해제)
    //    StoreDialog 완료 후 발행해야 후속 노드가 올바른 dialog 사용
    ex.engine.emitSIPEvent(instanceID, "TRANSFERRED")

    ex.engine.emitActionLog(node.ID, instanceID,
        fmt.Sprintf("TransferEvent: session replaced with new dialog (Refer-To: %s)", referToURIStr), "info")
    return nil
},
```

**핵심 순서 (안티패턴 방지):**
1. Refer-To URI 추출 → 2. ActionLog → 3. Invite+Ack → 4. StoreDialog → 5. emitSIPEvent
- StoreDialog 전에 emitSIPEvent 호출하면 후속 노드가 잘못된(기존) dialog 사용
- Invite() 없이 StoreDialog하면 비활성 dialog 참조

**에러 처리:**
- Invite 실패 시 에러 반환 → diago가 NOTIFY 전송 + referDialog 종료
- emitSIPEvent("TRANSFERRED") 미발행 → TransferEvent 노드 타임아웃 → FailureNext 경로
- 이 동작은 의도적임 (연구 함정 2번)
  </action>
  <verify>
`cd /Users/kyh0703/Project/sipflow && go build ./...` -- 컴파일 성공.
`go vet ./internal/engine/...` -- 경고 없음.
기존 테스트: `go test ./internal/engine/ -v` -- 모두 통과.
grep 확인:
- `grep -n "referDialog.Invite" internal/engine/executor.go` -- Invite 호출 존재
- `grep -n "referDialog.Ack" internal/engine/executor.go` -- Ack 호출 존재
- `grep -n "StoreDialog.*referDialog" internal/engine/executor.go` -- SessionStore 교체
- `grep -n "Refer-To=" internal/engine/executor.go` -- URI 로그 기록
  </verify>
  <done>
OnRefer 콜백이 Refer-To URI를 추출하여 ActionLog에 기록한다. referDialog.Invite() + Ack()로 새 통화를 성립시킨다. StoreDialog()로 SessionStore를 교체한 후 emitSIPEvent("TRANSFERRED")를 발행한다. 에러 시 TRANSFERRED 미발행으로 TransferEvent 노드가 타임아웃/FailureNext로 진행한다. `go build ./...`와 기존 테스트가 모두 통과한다.
  </done>
</task>

<task type="auto">
  <name>Task 2: BlindTransfer + TRANSFERRED 에러 경로 + 이벤트 라우팅 테스트</name>
  <files>
    internal/engine/executor_test.go
  </files>
  <action>
기존 `newTestExecutor()` 헬퍼를 사용하여 Phase 11 전체 기능의 에러 경로 + 이벤트 라우팅 테스트를 추가한다.
기존 Phase 10 테스트 패턴(`TestExecuteHold_NoDialog`, `TestExecuteCommand_HoldSwitch`, `TestExecuteEvent_HeldSwitch`)을 따른다.

**새 테스트 함수들:**

1. `TestExecuteBlindTransfer_EmptyTargetUser`:
   - `newTestExecutor(t)` 생성
   - `node := &GraphNode{ID: "test-node", Type: "command", Command: "BlindTransfer", TargetUser: "", TargetHost: "192.168.1.100:5060"}`
   - `ex.executeBlindTransfer(context.Background(), "inst-1", node)` 호출
   - 에러 포함 확인: `"targetUser is required"`

2. `TestExecuteBlindTransfer_EmptyTargetHost`:
   - `newTestExecutor(t)` 생성
   - `node := &GraphNode{ID: "test-node", Type: "command", Command: "BlindTransfer", TargetUser: "carol", TargetHost: ""}`
   - `ex.executeBlindTransfer(context.Background(), "inst-1", node)` 호출
   - 에러 포함 확인: `"targetHost is required"`

3. `TestExecuteBlindTransfer_NoDialog`:
   - `newTestExecutor(t)` 생성
   - `node := &GraphNode{ID: "test-node", Type: "command", Command: "BlindTransfer", TargetUser: "carol", TargetHost: "192.168.1.100:5060"}`
   - `ex.executeBlindTransfer(context.Background(), "inst-1", node)` 호출
   - 에러 포함 확인: `"no active dialog"`

4. `TestExecuteCommand_BlindTransferSwitch`:
   - `newTestExecutor(t)` 생성
   - `node := &GraphNode{ID: "test-node", Type: "command", Command: "BlindTransfer", InstanceID: "inst-1", TargetUser: "carol", TargetHost: "192.168.1.100:5060"}`
   - `ex.executeCommand(context.Background(), "inst-1", node)` 호출
   - 에러 발생 확인 (dialog 없으므로 에러는 예상, switch 라우팅 검증)
   - 에러 메시지에 `"no active dialog"` 포함 (BlindTransfer 핸들러까지 도달 확인)

5. `TestExecuteEvent_TransferredSwitch`:
   - `newTestExecutor(t)` 생성
   - `node := &GraphNode{ID: "test-node", Type: "event", Event: "TRANSFERRED", InstanceID: "inst-1", Timeout: 100 * time.Millisecond}`
   - 100ms 타임아웃으로 `ex.executeEvent(context.Background(), "inst-1", node)` 호출
   - 에러 확인: `"TRANSFERRED event timeout"` (구독 후 이벤트 없으므로 타임아웃)

6. `TestExecuteWaitSIPEvent_Transferred_Success`:
   - `newTestExecutor(t)` 생성
   - goroutine으로 50ms 후 `ex.sessions.emitSIPEvent("inst-1", "TRANSFERRED")` 호출
   - `node := &GraphNode{ID: "test-node", Type: "event", Event: "TRANSFERRED", Timeout: 2 * time.Second}`
   - 2초 타임아웃 컨텍스트로 `ex.executeWaitSIPEvent(ctx, "inst-1", node, "TRANSFERRED", 2*time.Second)` 호출
   - 에러 없음 확인 (nil)

7. `TestParseScenario_BlindTransferFields`:
   - BlindTransfer 노드를 포함한 JSON flowData 생성:
     - sipInstance 노드 1개
     - command 노드 1개: `{"command": "BlindTransfer", "targetUser": "carol", "targetHost": "192.168.1.100:5060", "sipInstanceId": "<instance_id>"}`
     - 엣지: sipInstance → command
   - `ParseScenario(flowData)` 호출
   - 결과 GraphNode에서 `TargetUser == "carol"`, `TargetHost == "192.168.1.100:5060"` 확인
   - `Command == "BlindTransfer"` 확인
  </action>
  <verify>
전체 테스트: `cd /Users/kyh0703/Project/sipflow && go test ./internal/engine/ -v` -- 모든 테스트 통과 (기존 + Plan 01 확인 + Plan 02 신규).
신규 테스트만: `go test ./internal/engine/ -run "TestExecuteBlindTransfer|TestExecuteCommand_BlindTransfer|TestExecuteEvent_Transferred|TestExecuteWaitSIPEvent_Transferred|TestParseScenario_BlindTransfer" -v` -- 통과.
  </verify>
  <done>
BlindTransfer의 에러 경로(빈 targetUser, 빈 targetHost, dialog 미존재)가 테스트된다. executeCommand switch가 BlindTransfer를 올바르게 라우팅함이 검증된다. executeEvent switch가 TRANSFERRED를 올바르게 라우팅하고 타임아웃/성공 경로가 검증된다. ParseScenario가 BlindTransfer 필드를 올바르게 파싱함이 테스트된다. 전체 `go test ./internal/engine/`가 통과한다.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` -- 전체 프로젝트 컴파일 성공
2. `go test ./internal/engine/ -v` -- 모든 테스트 통과 (기존 + Phase 11 신규)
3. `go vet ./internal/engine/...` -- 경고 없음
4. 요구사항 매핑 확인:
   - XFER-01: `grep -n "executeBlindTransfer" internal/engine/executor.go` + `grep -n "case \"BlindTransfer\""`
   - XFER-02: `grep -n "case \"TRANSFERRED\"" internal/engine/executor.go` + `grep -n "referDialog.Invite" internal/engine/executor.go`
   - 성공기준 2: `grep -n "Refer-To:" internal/engine/executor.go` (BlindTransfer 성공 로그)
   - 성공기준 4: `grep -n "Refer-To=" internal/engine/executor.go` (TransferEvent URI 로그)
5. OnRefer 순서 검증:
   - `grep -n "StoreDialog" internal/engine/executor.go` -- StoreDialog이 emitSIPEvent 전에 호출됨
   - `grep -n "emitSIPEvent.*TRANSFERRED" internal/engine/executor.go` -- StoreDialog 뒤에 위치
</verification>

<success_criteria>
- XFER-02: OnRefer 콜백이 Refer-To URI를 추출하고 referDialog.Invite()+Ack()를 완료한 후 SessionStore를 교체하고 TRANSFERRED 이벤트를 발행한다
- OnRefer 콜백의 순서가 올바르다: URI 추출 → Invite+Ack → StoreDialog → emitSIPEvent
- OnRefer 에러 시 TRANSFERRED 미발행으로 TransferEvent 노드가 타임아웃/FailureNext로 진행한다
- BlindTransfer 에러 경로(빈 targetUser/targetHost, dialog 미존재)가 테스트된다
- TRANSFERRED 이벤트의 executeEvent 스위치 라우팅과 성공/타임아웃 경로가 테스트된다
- ParseScenario가 BlindTransfer 필드를 올바르게 파싱함이 테스트된다
- go build와 go test가 모두 통과한다
</success_criteria>

<output>
완료 후, `.planning/phases/11-blindtransfer-backend/11-02-SUMMARY.md` 생성
</output>
