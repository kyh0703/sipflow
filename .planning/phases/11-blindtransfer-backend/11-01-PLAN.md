---
phase: 11-blindtransfer-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/engine/executor.go
  - internal/engine/graph.go
autonomous: true

must_haves:
  truths:
    - "GraphNode에 TargetUser, TargetHost 필드가 존재하고 ParseScenario()에서 파싱된다"
    - "executeBlindTransfer()가 referrer 인터페이스 어서션으로 Refer()를 호출하고 즉시 Hangup(BYE)을 전송한다"
    - "executeBlindTransfer()가 targetUser/targetHost를 sip:{user}@{host}로 조합하고 sip.ParseUri()로 검증한다"
    - "executeCommand switch에 BlindTransfer가 등록되어 executeBlindTransfer()로 라우팅된다"
    - "executeEvent switch에 TRANSFERRED가 등록되어 executeWaitSIPEvent(TRANSFERRED)로 라우팅된다"
  artifacts:
    - path: "internal/engine/executor.go"
      provides: "executeBlindTransfer() 신규, executeCommand BlindTransfer 케이스, executeEvent TRANSFERRED 케이스"
      contains: "executeBlindTransfer"
    - path: "internal/engine/graph.go"
      provides: "GraphNode TargetUser/TargetHost 필드, ParseScenario 파싱 확장"
      contains: "TargetUser"
  key_links:
    - from: "internal/engine/executor.go executeBlindTransfer"
      to: "diago Refer()"
      via: "referrer 인터페이스 어서션 → r.Refer(ctx, referTo)"
      pattern: "referrer"
    - from: "internal/engine/executor.go executeBlindTransfer"
      to: "diago Hangup()"
      via: "dialog.Hangup(hangupCtx)"
      pattern: "Hangup"
    - from: "internal/engine/executor.go executeCommand"
      to: "internal/engine/executor.go executeBlindTransfer"
      via: "case BlindTransfer switch"
      pattern: "case \"BlindTransfer\""
    - from: "internal/engine/executor.go executeEvent"
      to: "internal/engine/executor.go executeWaitSIPEvent"
      via: "case TRANSFERRED switch"
      pattern: "case \"TRANSFERRED\""
    - from: "internal/engine/graph.go ParseScenario"
      to: "internal/engine/graph.go GraphNode"
      via: "getStringField(node.Data, targetUser/targetHost)"
      pattern: "TargetUser"
---

<objective>
GraphNode에 BlindTransfer용 TargetUser/TargetHost 필드를 추가하고, executeBlindTransfer() 함수를 구현하여 REFER 전송 + BYE를 실행한다. executeCommand/executeEvent 스위치를 확장하여 BlindTransfer/TRANSFERRED 노드를 라우팅한다.

Purpose: XFER-01 요구사항의 백엔드 실행 경로를 완성한다. BlindTransfer Command 노드가 캔버스에 배치되면 REFER 메시지가 전송되고 BYE로 통화가 종료된다. XFER-02의 이벤트 대기는 Phase 10에서 구현된 executeWaitSIPEvent()를 재사용하여 TRANSFERRED 케이스만 추가한다.
Output: executeBlindTransfer() 함수, GraphNode 필드 확장, executeCommand/executeEvent 스위치 확장, go build 통과
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-blindtransfer-backend/11-RESEARCH.md
@.planning/phases/11-blindtransfer-backend/CONTEXT.md
@internal/engine/executor.go
@internal/engine/graph.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: GraphNode TargetUser/TargetHost 필드 추가 + ParseScenario 파싱 확장</name>
  <files>
    internal/engine/graph.go
  </files>
  <action>
**graph.go — GraphNode 구조체 확장:**
기존 `TransferTarget string` 필드(Phase 10에서 추가한 레거시) 뒤에 두 필드를 추가:

```go
TransferTarget string        // 레거시 (Phase 10 대비)
TargetUser     string        // BlindTransfer 대상 user 부분 (Phase 11)
TargetHost     string        // BlindTransfer 대상 host:port (Phase 11)
```

`TargetUser`는 BlindTransfer 대상의 SIP user 부분 (예: "carol").
`TargetHost`는 BlindTransfer 대상의 host:port 부분 (예: "192.168.1.100:5060").
executor에서 `sip:{TargetUser}@{TargetHost}`로 조합하여 sip.Uri로 파싱한다.

**ParseScenario() 확장:**
command 노드 파싱 블록에서 기존 `gnode.TransferTarget = getStringField(...)` 라인 뒤에 추가:
```go
gnode.TargetUser = getStringField(node.Data, "targetUser", "")
gnode.TargetHost = getStringField(node.Data, "targetHost", "")
```

Command 필드 설명 주석(`Command string`)의 뒤에 BlindTransfer도 추가:
기존: `// MakeCall|Answer|Release|PlayAudio|SendDTMF (command 노드 전용)`
변경: `// MakeCall|Answer|Release|PlayAudio|SendDTMF|Hold|Retrieve|BlindTransfer (command 노드 전용)`

Event 필드 설명 주석도 업데이트:
기존: `// INCOMING|DISCONNECTED|RINGING|TIMEOUT|DTMFReceived (event 노드 전용)`
변경: `// INCOMING|DISCONNECTED|RINGING|TIMEOUT|DTMFReceived|HELD|RETRIEVED|TRANSFERRED (event 노드 전용)`
  </action>
  <verify>
`cd /Users/kyh0703/Project/sipflow && go build ./...` -- 컴파일 성공.
`go vet ./internal/engine/...` -- 경고 없음.
grep 확인:
- `grep -n "TargetUser" internal/engine/graph.go` -- 필드 정의 + ParseScenario 파싱
- `grep -n "TargetHost" internal/engine/graph.go` -- 필드 정의 + ParseScenario 파싱
  </verify>
  <done>
GraphNode에 TargetUser, TargetHost 필드가 존재한다. ParseScenario()에서 command 노드의 targetUser/targetHost를 파싱한다. Command/Event 필드 주석이 Phase 10/11의 새 노드 타입을 포함한다. `go build ./...`가 성공한다.
  </done>
</task>

<task type="auto">
  <name>Task 2: executeBlindTransfer() 구현 + executeCommand/executeEvent 스위치 확장</name>
  <files>
    internal/engine/executor.go
  </files>
  <action>
**executeBlindTransfer() 함수 추가:**
executeRetrieve() 함수 뒤, executeWaitSIPEvent() 함수 앞에 배치.
11-RESEARCH.md 패턴 1 (예시 1: 완전한 executeBlindTransfer 구현)을 따른다.

```go
func (ex *Executor) executeBlindTransfer(ctx context.Context, instanceID string, node *GraphNode) error
```

구현 상세:
1. targetUser/targetHost 검증:
   - `node.TargetUser == ""` → 에러: `"BlindTransfer: targetUser is required"`
   - `node.TargetHost == ""` → 에러: `"BlindTransfer: targetHost is required"`
2. Dialog 조회: `ex.sessions.GetDialog(instanceID)` — 없으면 에러: `"BlindTransfer: no active dialog for instance %s"`
3. SIP URI 조합: `rawURI := fmt.Sprintf("sip:%s@%s", node.TargetUser, node.TargetHost)`
4. `sip.ParseUri(rawURI, &referTo)` — 실패 시 에러: `"BlindTransfer: invalid target URI %q: %w"`
5. 로컬 referrer 인터페이스 어서션 (Phase 10 reInviter 패턴과 동일):
   ```go
   type referrer interface {
       Refer(ctx context.Context, referTo sip.Uri, headers ...sip.Header) error
   }
   ```
   어서션 실패 시 에러: `"BlindTransfer: dialog type %T does not support Refer"`
6. 액션 로그: `"BlindTransfer: sending REFER to %s"` (rawURI 포함)
7. `r.Refer(ctx, referTo)` 호출 — 실패 시 에러: `"BlindTransfer: REFER failed: %w"`
8. 성공 로그 (ROADMAP 성공기준 2번): `"BlindTransfer succeeded (Refer-To: %s)"` + `WithSIPMessage("sent", "REFER", 202, "", "", rawURI)`
9. 즉시 BYE (CONTEXT.md 결정사항):
   - 5초 타임아웃: `hangupCtx, cancel := context.WithTimeout(ctx, 5*time.Second)`
   - `dialog.Hangup(hangupCtx)` — 실패 시 경고 로그만 (에러 무시)
   - BYE 로그: `"BlindTransfer: BYE sent"` + `WithSIPMessage("sent", "BYE", 200, "", "", "")`
10. `return nil`

**executeCommand() 스위치 확장:**
기존 `case "Retrieve":` 뒤, `default:` 앞에 추가:
```go
case "BlindTransfer":
    return ex.executeBlindTransfer(ctx, instanceID, node)
```

**executeEvent() 스위치 확장:**
기존 `case "RETRIEVED":` 뒤, `default:` 앞에 추가:
```go
case "TRANSFERRED":
    return ex.executeWaitSIPEvent(timeoutCtx, instanceID, node, "TRANSFERRED", timeout)
```

**주의사항:**
- `sip` import는 이미 존재 (`"github.com/emiago/sipgo/sip"`)
- referrer 인터페이스는 함수 내부에 로컬로 정의 (exported 불필요)
- executeBlindTransfer에서 Refer 호출 전에 ActionLog를 발행하여, 실패 시에도 시도 기록이 남음
  </action>
  <verify>
`cd /Users/kyh0703/Project/sipflow && go build ./...` -- 컴파일 성공 (sip import 포함).
`go vet ./internal/engine/...` -- 경고 없음.
기존 테스트: `go test ./internal/engine/ -run "TestExecuteChain|TestSessionStore_StoreAndGet|TestSessionStore_ThreadSafety" -v` -- 모두 통과.
grep 확인:
- `grep -n "executeBlindTransfer" internal/engine/executor.go` -- 함수 정의 + switch case
- `grep -n "case \"BlindTransfer\"" internal/engine/executor.go` -- executeCommand switch에 등록됨
- `grep -n "case \"TRANSFERRED\"" internal/engine/executor.go` -- executeEvent switch에 등록됨
- `grep -n "referrer" internal/engine/executor.go` -- 로컬 인터페이스 정의
  </verify>
  <done>
executeBlindTransfer()가 referrer 인터페이스 어서션으로 Refer()를 호출하고 즉시 Hangup(BYE)을 전송한다. executeCommand switch에 BlindTransfer가 등록된다. executeEvent switch에 TRANSFERRED가 등록되어 기존 executeWaitSIPEvent()를 재사용한다. `go build ./...`와 기존 테스트가 모두 통과한다.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` -- 전체 프로젝트 컴파일 성공
2. `go test ./internal/engine/ -v` -- 모든 기존 테스트 통과
3. `go vet ./internal/engine/...` -- 경고 없음
4. grep으로 핵심 연결 확인:
   - `grep -n "TargetUser" internal/engine/graph.go` -- GraphNode 필드 + ParseScenario 파싱
   - `grep -n "TargetHost" internal/engine/graph.go` -- GraphNode 필드 + ParseScenario 파싱
   - `grep -n "executeBlindTransfer" internal/engine/executor.go` -- 함수 정의 존재
   - `grep -n "case \"BlindTransfer\"" internal/engine/executor.go` -- switch 등록
   - `grep -n "case \"TRANSFERRED\"" internal/engine/executor.go` -- switch 등록
   - `grep -n "referrer" internal/engine/executor.go` -- 로컬 인터페이스 정의
   - `grep -n "Hangup" internal/engine/executor.go` -- BlindTransfer 내 BYE 전송
</verification>

<success_criteria>
- XFER-01 백엔드: BlindTransfer Command가 executeCommand switch에 등록되고 executeBlindTransfer()가 REFER + BYE를 실행한다
- XFER-02 백엔드 (이벤트 대기): TRANSFERRED가 executeEvent switch에 등록되어 executeWaitSIPEvent("TRANSFERRED")로 블로킹 대기한다
- GraphNode에 TargetUser/TargetHost 필드가 존재하고 ParseScenario에서 파싱된다
- go build와 기존 go test가 모두 통과한다
</success_criteria>

<output>
완료 후, `.planning/phases/11-blindtransfer-backend/11-01-SUMMARY.md` 생성
</output>
